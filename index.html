<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة المراسلة المباشرة - P2P Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========== CSS كامل ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --bg-color: #f5f7fb;
            --card-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* شريط العنوان */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4757;
            animation: pulse 2s infinite;
            position: relative;
        }

        .status-dot.connecting {
            background-color: #ffa502;
            animation: pulse-connecting 1s infinite;
        }

        .status-dot.connected {
            background-color: #2ed573;
            animation: pulse-connected 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-connecting {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(255, 165, 2, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(255, 165, 2, 0);
            }
        }

        @keyframes pulse-connected {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(46, 213, 115, 0);
            }
        }

        /* المحتوى الرئيسي */
        .app-main {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            flex: 1;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .app-main {
                grid-template-columns: 1fr;
            }
        }

        /* لوحة التحكم */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .panel-card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-with-button input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-with-button input:read-only {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        /* الأزرار */
        .btn-primary, .btn-secondary, .btn-icon, .btn-send {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            min-width: 120px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.2);
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-icon {
            padding: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
            width: 48px;
            height: 48px;
        }

        .btn-icon:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            padding: 12px 30px;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 201, 240, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        /* معلومات الاتصال */
        .connection-info {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed var(--border-color);
        }

        .connection-info h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .info-item:hover {
            transform: translateY(-3px);
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-color);
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--dark-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* التعليمات */
        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions ol {
            padding-right: 20px;
            margin-bottom: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            padding-right: 10px;
            position: relative;
        }

        .instructions li::before {
            content: '';
            position: absolute;
            right: -20px;
            top: 8px;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .features {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feature-tag {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #00695c;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s ease;
        }

        .feature-tag:hover {
            transform: scale(1.05);
        }

        /* منطقة المحادثة */
        .chat-section {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .peer-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .message-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* نافذة الرسائل */
        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #fafbfd;
            min-height: 400px;
            max-height: 60vh;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(0,0,0,0.05) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, rgba(0,0,0,0.05) 2px, transparent 0);
            background-size: 100px 100px;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }

        .welcome-message i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-message h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .welcome-message p {
            font-size: 1.1rem;
        }

        /* الرسائل الفردية */
        .message {
            margin-bottom: 20px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background: var(--light-color);
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.sent .message-time {
            text-align: left;
            color: var(--primary-color);
        }

        .message.received .message-time {
            text-align: right;
            color: var(--gray-color);
        }

        /* منطقة إدخال الرسالة */
        .message-input-area {
            padding: 25px;
            border-top: 2px solid var(--border-color);
            background: var(--card-color);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-container textarea:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .input-hint {
            text-align: center;
            margin-top: 10px;
            color: var(--gray-color);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        kbd {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        /* التذييل */
        .app-footer {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-top: auto;
            border: 1px solid var(--border-color);
        }

        .footer-content p {
            margin-bottom: 10px;
            color: var(--gray-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tech-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        /* الإشعارات */
        #notificationArea {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 350px;
            border-right: 4px solid var(--primary-color);
            transform-origin: left center;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-100%) scale(0.8); }
        }

        .notification.success {
            border-right-color: var(--success-color);
        }

        .notification.error {
            border-right-color: var(--danger-color);
        }

        .notification.warning {
            border-right-color: var(--warning-color);
        }

        .notification.info {
            border-right-color: var(--primary-color);
        }

        .notification i {
            font-size: 1.5rem;
        }

        .notification.success i {
            color: var(--success-color);
        }

        .notification.error i {
            color: var(--danger-color);
        }

        .notification.warning i {
            color: var(--warning-color);
        }

        .notification.info i {
            color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-content h4 {
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .notification-content p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        /* نافذة الإيموجي */
        .emoji-picker {
            position: fixed;
            bottom: 120px;
            left: 30px;
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .emoji-picker.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .emoji-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-header h4 {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .emoji-grid {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background: var(--light-color);
            transform: scale(1.2);
        }

        /* إعادة الاتصال */
        .reconnect-banner {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .reconnect-banner button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reconnect-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* قائمة الاقتراحات */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestions-dropdown.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f5f7fb;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .input-with-suggestions {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* إدارة المعرفات */
        .id-management {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed var(--border-color);
        }

        .id-management h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .id-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .id-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border-right: 3px solid var(--primary-color);
        }

        .id-item.active {
            background: #e8f4ff;
            border-right-color: var(--success-color);
        }

        .id-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .id-actions {
            display: flex;
            gap: 5px;
        }

        .id-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--gray-color);
            transition: color 0.2s;
        }

        .id-btn:hover {
            color: var(--primary-color);
        }

        .id-btn.use {
            color: var(--success-color);
        }

        .id-btn.delete {
            color: var(--danger-color);
        }

        /* مخصص للشاشات الصغيرة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .app-main {
                gap: 20px;
            }
            
            .panel-card, .chat-header, .message-input-area {
                padding: 15px;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .message {
                max-width: 90%;
            }
            
            .emoji-picker {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .reconnect-banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* تأثيرات التحميل */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- شريط العنوان -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <h1>P2P Messenger</h1>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">غير متصل</span>
                </div>
            </div>
        </header>

        <!-- إعادة الاتصال -->
        <div id="reconnectBanner" class="reconnect-banner" style="display: none;">
            <span>لديك اتصال سابق، هل تريد إعادة الاتصال؟</span>
            <div>
                <button id="reconnectBtn" class="btn-reconnect">
                    <i class="fas fa-plug"></i> إعادة الاتصال
                </button>
                <button id="dismissReconnect" class="btn-reconnect">
                    <i class="fas fa-times"></i> تجاهل
                </button>
            </div>
        </div>

        <main class="app-main">
            <!-- لوحة التحكم -->
            <section class="control-panel">
                <div class="panel-card">
                    <h2><i class="fas fa-cogs"></i> إدارة الاتصال</h2>
                    
                    <div class="connection-controls">
                        <!-- معرفك الخاص -->
                        <div class="control-group">
                            <label for="myId"><i class="fas fa-fingerprint"></i> معرفك الخاص</label>
                            <div class="input-with-button">
                                <input type="text" id="myId" placeholder="أدخل معرفك المفضل">
                                <button id="saveMyId" class="btn-primary">
                                    <i class="fas fa-save"></i> حفظ
                                </button>
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> أدخل أي اسم أو رمز تريد (مثال: أحمد، خالد123، room1)
                            </small>
                        </div>

                        <!-- قائمة معرفاتك السابقة -->
                        <div class="id-management" id="myIdManagement" style="display: none;">
                            <h4><i class="fas fa-history"></i> معرفاتك السابقة</h4>
                            <div class="id-list" id="myIdList">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </div>
                        </div>

                        <!-- إدخال معرف الجهة الأخرى -->
                        <div class="control-group">
                            <label for="peerId"><i class="fas fa-user-plus"></i> معرف الشخص الآخر</label>
                            <div class="input-with-suggestions">
                                <div class="input-with-button">
                                    <input type="text" id="peerId" placeholder="أدخل معرف الشخص الآخر">
                                    <button id="connectBtn" class="btn-primary">
                                        <i class="fas fa-plug"></i> الاتصال
                                    </button>
                                </div>
                                <div class="suggestions-dropdown" id="peerSuggestions">
                                    <!-- سيتم ملؤها بواسطة JavaScript -->
                                </div>
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-history"></i> سيتم حفظ جميع المعرفات للاتصال السريع
                            </small>
                        </div>

                        <!-- نوع الاتصال -->
                        <div class="control-group">
                            <label><i class="fas fa-network-wired"></i> نوع الاتصال</label>
                            <div class="connection-mode">
                                <select id="connectionMode" class="input-with-button" style="width: 100%; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;">
                                    <option value="auto">تلقائي (أفضل سرعة)</option>
                                    <option value="reliable">موثوق (للاتصالات الصعبة)</option>
                                    <option value="fast">سريع (للاتصالات المحلية)</option>
                                </select>
                            </div>
                        </div>

                        <!-- إجراءات -->
                        <div class="action-buttons">
                            <button id="disconnectBtn" class="btn-secondary" disabled>
                                <i class="fas fa-plug-circle-xmark"></i> قطع الاتصال
                            </button>
                            <button id="clearChatBtn" class="btn-secondary">
                                <i class="fas fa-trash"></i> مسح المحادثة
                            </button>
                            <button id="testConnectionBtn" class="btn-secondary">
                                <i class="fas fa-bolt"></i> اختبار الاتصال
                            </button>
                        </div>

                        <!-- معلومات الاتصال -->
                        <div class="connection-info" id="connectionInfo" style="display: none;">
                            <h3><i class="fas fa-info-circle"></i> معلومات الاتصال</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">الحالة:</span>
                                    <span class="info-value" id="connState">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">النوع:</span>
                                    <span class="info-value" id="connType">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">السرعة:</span>
                                    <span class="info-value" id="connSpeed">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">جودة:</span>
                                    <span class="info-value" id="connQuality">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- التعليمات -->
                <div class="panel-card instructions">
                    <h3><i class="fas fa-lightbulb"></i> نصائح لاتصال أفضل</h3>
                    <ol>
                        <li><strong>نفس الشبكة:</strong> تأكد أن كلا الجهازين على نفس شبكة WiFi لاتصال أسرع</li>
                        <li><strong>جرب جميع الأنواع:</strong> إذا فشل الاتصال، جرب تغيير نوع الاتصال من القائمة</li>
                        <li><strong>أعد المحاولة:</strong> أحياناً تحتاج لمحاولة ثانية أو ثالثة</li>
                        <li><strong>أعد تحميل الصفحة:</strong> إذا استمر الفشل، أعد تحميل الصفحة على كلا الجهازين</li>
                        <li><strong>عطل مؤقت:</strong> بعض الشبكات تمنع اتصالات P2P، جرب شبكة أخرى</li>
                    </ol>
                    <div class="features">
                        <span class="feature-tag"><i class="fas fa-shield-alt"></i> مشفر</span>
                        <span class="feature-tag"><i class="fas fa-bolt"></i> فوري</span>
                        <span class="feature-tag"><i class="fas fa-server"></i> لا سيرفرات</span>
                        <span class="feature-tag"><i class="fas fa-wifi"></i> اتصال مباشر</span>
                    </div>
                </div>
            </section>

            <!-- منطقة المحادثة -->
            <section class="chat-section">
                <div class="chat-container">
                    <!-- رأس المحادثة -->
                    <div class="chat-header">
                        <h2><i class="fas fa-comment-dots"></i> المحادثة</h2>
                        <div class="chat-info" id="chatInfo">
                            <span id="peerName" class="peer-name">لم يتم الاتصال بعد</span>
                            <span class="message-count" id="messageCount">0 رسالة</span>
                        </div>
                    </div>

                    <!-- نافذة الرسائل -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="welcome-message">
                            <i class="fas fa-handshake"></i>
                            <h3>مرحبًا في منصة المراسلة المباشرة</h3>
                            <p>قم بالاتصال بشخص آخر لبدء المحادثة</p>
                            <div style="margin-top: 20px; color: var(--gray-color); font-size: 0.9rem;">
                                <i class="fas fa-tips"></i> إذا واجهت مشاكل في الاتصال، جرب تغيير نوع الاتصال
                            </div>
                        </div>
                    </div>

                    <!-- منطقة إدخال الرسالة -->
                    <div class="message-input-area">
                        <div class="input-container">
                            <textarea 
                                id="messageInput" 
                                placeholder="اكتب رسالتك هنا..." 
                                rows="2"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button id="sendBtn" class="btn-send" disabled>
                                    <i class="fas fa-paper-plane"></i> إرسال
                                </button>
                                <button id="emojiBtn" class="btn-icon" title="إيموجي">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-hint">
                            <i class="fas fa-keyboard"></i> اضغط <kbd>Enter</kbd> للإرسال، <kbd>Shift+Enter</kbd> لسطر جديد
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- التذييل -->
        <footer class="app-footer">
            <div class="footer-content">
                <p>
                    <i class="fas fa-code"></i> مبني بواسطة
                    <strong>يحيى محمد</strong> للتواصل <strong>20114165562+ </strong>
                </p>
                <p class="tech-badges">
                    <span class="badge">WebRTC</span>
                    <span class="badge">P2P</span>
                    <span class="badge">End-to-End</span>
                    <span class="badge">Direct Connect</span>
                </p>
            </div>
        </footer>

        <!-- الإشعارات -->
        <div id="notificationArea"></div>

        <!-- نافذة الإيموجي -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header">
                <h4>اختر إيموجي</h4>
                <button class="btn-icon close-emoji">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="emoji-grid">
                <!-- سيتم إضافة الإيموجي عبر JavaScript -->
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript عبر CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- كود JavaScript مدمج -->
    <script>
        // ========== JavaScript محسّن للاتصال الموثوق ==========
        class P2PMessenger {
            constructor() {
                this.peer = null;
                this.connection = null;
                this.myId = this.getOrCreateId();
                this.messages = [];
                this.isConnected = false;
                this.connectionAttempts = 0;
                this.maxConnectionAttempts = 10;
                this.reconnectTimeout = null;
                this.savedMyIds = this.getSavedMyIds();
                this.savedPeerIds = this.getSavedPeerIds();
                this.connectionMode = 'auto';
                this.connectionMonitor = null;
                this.pingInterval = null;
                this.lastPingTime = 0;
                this.pingLatency = 0;
                this.connectionStats = {
                    attempts: 0,
                    successes: 0,
                    failures: 0,
                    avgLatency: 0
                };
                
                this.initializeElements();
                this.initializeEventListeners();
                this.initializePeer();
                this.initializeEmojiPicker();
                this.restoreChat();
                this.updateUI();
                
                // محاولة إعادة الاتصال التلقائي
                this.attemptAutoReconnect();
                
                // حفظ الإحصائيات
                this.loadConnectionStats();
            }

            // الحصول على المعرف المخزن أو إنشاء جديد
            getOrCreateId() {
                let savedId = localStorage.getItem('p2p_messenger_current_id');
                
                // إذا لم يوجد معرف مخزن، استخدام معرف افتراضي
                if (!savedId) {
                    savedId = 'user-' + Math.random().toString(36).substr(2, 8);
                    localStorage.setItem('p2p_messenger_current_id', savedId);
                    this.saveMyId(savedId);
                }
                
                return savedId;
            }

            // الحصول على معرفاتي المحفوظة
            getSavedMyIds() {
                try {
                    const ids = JSON.parse(localStorage.getItem('p2p_messenger_my_ids') || '[]');
                    return ids;
                } catch (e) {
                    return [];
                }
            }

            // الحصول على معرفات الأطراف المحفوظة
            getSavedPeerIds() {
                try {
                    const ids = JSON.parse(localStorage.getItem('p2p_messenger_peer_ids') || '[]');
                    return ids;
                } catch (e) {
                    return [];
                }
            }

            // حفظ معرفي
            saveMyId(id) {
                if (!id || id.trim() === '') return false;
                
                id = id.trim();
                
                // التحقق من عدم تكرار المعرف
                if (!this.savedMyIds.includes(id)) {
                    this.savedMyIds.unshift(id); // إضافة في البداية
                    
                    // الاحتفاظ بـ 10 معرفات فقط
                    if (this.savedMyIds.length > 10) {
                        this.savedMyIds = this.savedMyIds.slice(0, 10);
                    }
                    
                    localStorage.setItem('p2p_messenger_my_ids', JSON.stringify(this.savedMyIds));
                }
                
                // حفظ المعرف الحالي
                localStorage.setItem('p2p_messenger_current_id', id);
                this.myId = id;
                this.elements.myId.value = id;
                
                return true;
            }

            // حفظ معرف الطرف الآخر
            savePeerId(peerId) {
                if (!peerId || peerId.trim() === '') return;
                
                peerId = peerId.trim();
                
                // التحقق من عدم تكرار المعرف
                if (!this.savedPeerIds.includes(peerId)) {
                    this.savedPeerIds.unshift(peerId); // إضافة في البداية
                    
                    // الاحتفاظ بـ 15 معرفاً فقط
                    if (this.savedPeerIds.length > 15) {
                        this.savedPeerIds = this.savedPeerIds.slice(0, 15);
                    }
                    
                    localStorage.setItem('p2p_messenger_peer_ids', JSON.stringify(this.savedPeerIds));
                }
                
                localStorage.setItem('p2p_last_peer', peerId);
                localStorage.setItem('p2p_was_connected', 'true');
            }

            // تحميل إحصائيات الاتصال
            loadConnectionStats() {
                try {
                    const stats = JSON.parse(localStorage.getItem('p2p_connection_stats') || '{}');
                    this.connectionStats = { ...this.connectionStats, ...stats };
                } catch (e) {
                    console.log('❌ لا توجد إحصائيات سابقة');
                }
            }

            // حفظ إحصائيات الاتصال
            saveConnectionStats() {
                try {
                    localStorage.setItem('p2p_connection_stats', JSON.stringify(this.connectionStats));
                } catch (e) {
                    console.error('❌ خطأ في حفظ الإحصائيات');
                }
            }

            // تهيئة العناصر
            initializeElements() {
                this.elements = {
                    myId: document.getElementById('myId'),
                    peerId: document.getElementById('peerId'),
                    saveMyId: document.getElementById('saveMyId'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    clearChatBtn: document.getElementById('clearChatBtn'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectionInfo: document.getElementById('connectionInfo'),
                    connState: document.getElementById('connState'),
                    connType: document.getElementById('connType'),
                    connSpeed: document.getElementById('connSpeed'),
                    connQuality: document.getElementById('connQuality'),
                    chatInfo: document.getElementById('chatInfo'),
                    peerName: document.getElementById('peerName'),
                    messageCount: document.getElementById('messageCount'),
                    emojiBtn: document.getElementById('emojiBtn'),
                    emojiPicker: document.getElementById('emojiPicker'),
                    reconnectBanner: document.getElementById('reconnectBanner'),
                    reconnectBtn: document.getElementById('reconnectBtn'),
                    dismissReconnect: document.getElementById('dismissReconnect'),
                    myIdManagement: document.getElementById('myIdManagement'),
                    myIdList: document.getElementById('myIdList'),
                    peerSuggestions: document.getElementById('peerSuggestions'),
                    connectionMode: document.getElementById('connectionMode'),
                    testConnectionBtn: document.getElementById('testConnectionBtn')
                };

                this.elements.myId.value = this.myId;
                this.renderMyIdList();
                this.renderPeerSuggestions();
                
                // تحميل آخر معرف اتصال
                const lastPeerId = localStorage.getItem('p2p_last_peer');
                if (lastPeerId) {
                    this.elements.peerId.value = lastPeerId;
                }

                // تحميل آخر إعدادات الاتصال
                const savedMode = localStorage.getItem('p2p_connection_mode');
                if (savedMode) {
                    this.connectionMode = savedMode;
                    this.elements.connectionMode.value = savedMode;
                }

                // إظهار إدارة المعرفات إذا كان هناك معرفات محفوظة
                if (this.savedMyIds.length > 1) {
                    this.elements.myIdManagement.style.display = 'block';
                }

                // إضافة أحداث للاقتراحات
                this.elements.peerId.addEventListener('input', () => this.updatePeerSuggestions());
                this.elements.peerId.addEventListener('focus', () => this.showPeerSuggestions());
                this.elements.peerId.addEventListener('blur', () => {
                    setTimeout(() => this.hidePeerSuggestions(), 200);
                });

                // تحديث وضع الاتصال
                this.elements.connectionMode.addEventListener('change', (e) => {
                    this.connectionMode = e.target.value;
                    localStorage.setItem('p2p_connection_mode', this.connectionMode);
                    this.showNotification('info', 'تم التغيير', `وضع الاتصال: ${this.getModeName(this.connectionMode)}`);
                });
            }

            // الحصول على اسم وضع الاتصال
            getModeName(mode) {
                const names = {
                    'auto': 'تلقائي',
                    'reliable': 'موثوق',
                    'fast': 'سريع'
                };
                return names[mode] || mode;
            }

            // عرض قائمة معرفاتي
            renderMyIdList() {
                if (this.savedMyIds.length === 0) return;
                
                this.elements.myIdList.innerHTML = '';
                
                this.savedMyIds.forEach((id, index) => {
                    const isActive = id === this.myId;
                    const item = document.createElement('div');
                    item.className = `id-item ${isActive ? 'active' : ''}`;
                    
                    item.innerHTML = `
                        <span class="id-name">${this.escapeHtml(id)}</span>
                        <div class="id-actions">
                            ${!isActive ? `<button class="id-btn use" data-id="${index}" title="استخدم هذا المعرف"><i class="fas fa-check"></i></button>` : ''}
                            <button class="id-btn delete" data-id="${index}" title="حذف هذا المعرف"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    
                    this.elements.myIdList.appendChild(item);
                });

                // إضافة أحداث للأزرار
                this.elements.myIdList.querySelectorAll('.id-btn.use').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('.id-btn').dataset.id);
                        this.useMyId(index);
                    });
                });

                this.elements.myIdList.querySelectorAll('.id-btn.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const index = parseInt(e.target.closest('.id-btn').dataset.id);
                        this.deleteMyId(index);
                    });
                });
            }

            // عرض اقتراحات معرفات الأطراف
            renderPeerSuggestions() {
                if (this.savedPeerIds.length === 0) return;
                
                this.elements.peerSuggestions.innerHTML = '';
                
                this.savedPeerIds.forEach((id, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = id;
                    item.dataset.id = id;
                    
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.elements.peerId.value = id;
                        this.hidePeerSuggestions();
                    });
                    
                    this.elements.peerSuggestions.appendChild(item);
                });
            }

            // تحديث اقتراحات الأطراف أثناء الكتابة
            updatePeerSuggestions() {
                const searchTerm = this.elements.peerId.value.toLowerCase().trim();
                
                if (searchTerm === '') {
                    this.renderPeerSuggestions();
                    return;
                }
                
                const filteredIds = this.savedPeerIds.filter(id => 
                    id.toLowerCase().includes(searchTerm)
                );
                
                this.elements.peerSuggestions.innerHTML = '';
                
                if (filteredIds.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = 'لا توجد اقتراحات';
                    item.style.color = 'var(--gray-color)';
                    item.style.fontStyle = 'italic';
                    this.elements.peerSuggestions.appendChild(item);
                    return;
                }
                
                filteredIds.forEach((id, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    
                    // تمييز النص المتطابق
                    const startIndex = id.toLowerCase().indexOf(searchTerm);
                    if (startIndex !== -1) {
                        const before = this.escapeHtml(id.substring(0, startIndex));
                        const match = this.escapeHtml(id.substring(startIndex, startIndex + searchTerm.length));
                        const after = this.escapeHtml(id.substring(startIndex + searchTerm.length));
                        item.innerHTML = `${before}<strong>${match}</strong>${after}`;
                    } else {
                        item.textContent = id;
                    }
                    
                    item.dataset.id = id;
                    
                    item.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        this.elements.peerId.value = id;
                        this.hidePeerSuggestions();
                    });
                    
                    this.elements.peerSuggestions.appendChild(item);
                });
            }

            // إظهار اقتراحات الأطراف
            showPeerSuggestions() {
                if (this.savedPeerIds.length > 0) {
                    this.elements.peerSuggestions.classList.add('show');
                }
            }

            // إخفاء اقتراحات الأطراف
            hidePeerSuggestions() {
                this.elements.peerSuggestions.classList.remove('show');
            }

            // استخدام معرف من قائمة معرفاتي
            useMyId(index) {
                const id = this.savedMyIds[index];
                if (!id) return;
                
                if (this.isConnected) {
                    this.showNotification('warning', 'اتصال نشط', 'لا يمكن تغيير المعرف أثناء الاتصال');
                    return;
                }
                
                if (confirm(`هل تريد استخدام المعرف "${id}"؟`)) {
                    this.myId = id;
                    this.elements.myId.value = id;
                    localStorage.setItem('p2p_messenger_current_id', id);
                    
                    // إعادة تهيئة Peer
                    if (this.peer) {
                        this.peer.destroy();
                    }
                    this.initializePeer();
                    
                    this.showNotification('success', 'تم التغيير', `تم تعيين المعرف "${id}"`);
                    this.renderMyIdList();
                }
            }

            // حذف معرف من قائمة معرفاتي
            deleteMyId(index) {
                const id = this.savedMyIds[index];
                if (!id) return;
                
                if (id === this.myId) {
                    this.showNotification('warning', 'لا يمكن الحذف', 'لا يمكن حذف المعرف الحالي النشط');
                    return;
                }
                
                if (confirm(`هل تريد حذف المعرف "${id}"؟`)) {
                    this.savedMyIds.splice(index, 1);
                    localStorage.setItem('p2p_messenger_my_ids', JSON.stringify(this.savedMyIds));
                    this.renderMyIdList();
                    this.showNotification('success', 'تم الحذف', `تم حذف المعرف "${id}"`);
                    
                    // إخفاء قسم إدارة المعرفات إذا لم يعد هناك معرفات
                    if (this.savedMyIds.length <= 1) {
                        this.elements.myIdManagement.style.display = 'none';
                    }
                }
            }

            // الحصول على إعدادات ICE حسب نوع الاتصال
            getIceServers() {
                // قائمة شاملة من خوادم STUN/TURN
                const iceServers = [
                    // Google STUN servers
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' },
                    
                    // Other public STUN servers
                    { urls: 'stun:stun.voipbuster.com:3478' },
                    { urls: 'stun:stun.voipstunt.com:3478' },
                    { urls: 'stun:stun.voiparound.com:3478' },
                    { urls: 'stun:stun.voip.aebc.com:3478' },
                    { urls: 'stun:stun.sipgate.net:3478' },
                    { urls: 'stun:stun.iptel.org:3478' },
                    { urls: 'stun:stun.ideasip.com:3478' },
                    { urls: 'stun:stun.ekiga.net:3478' },
                    { urls: 'stun:stun.schlund.de:3478' },
                    { urls: 'stun:stun.rixtelecom.se:3478' },
                    { urls: 'stun:stun.sipgate.net:10000' },
                    { urls: 'stun:stun.12connect.com:3478' },
                    { urls: 'stun:stun.12voip.com:3478' },
                    { urls: 'stun:stun.counterpath.com:3478' },
                    { urls: 'stun:stun.counterpath.net:3478' },
                    { urls: 'stun:stun.internetcalls.com:3478' },
                    { urls: 'stun:stun.voip.eutelia.it:3478' },
                    
                    // TURN servers (بعضها قد يعمل بدون مصادقة)
                    { urls: 'turn:turn.bistri.com:80', credential: 'homeo', username: 'homeo' },
                    { urls: 'turn:turn.anyfirewall.com:443?transport=tcp', credential: 'webrtc', username: 'webrtc' },
                    
                    // أكثر موثوقية للاتصالات الصعبة
                    { 
                        urls: [
                            'turn:global.turn.twilio.com:3478?transport=udp',
                            'turn:global.turn.twilio.com:3478?transport=tcp',
                            'turn:global.turn.twilio.com:443?transport=tcp'
                        ],
                        username: 'c84c2b8a8bbdd0ee37934b3e1d1df6c7e4c11d5b09795bdc176a247a1e1d6a',
                        credential: 'Aedp5kY14yWgNp+flE6WlTpxTE0='
                    }
                ];

                // تصفية حسب نوع الاتصال
                switch(this.connectionMode) {
                    case 'reliable':
                        // استخدم جميع الخوادم لزيادة الموثوقية
                        return iceServers;
                    case 'fast':
                        // استخدم فقط STUN سريع للاتصالات المحلية
                        return iceServers.filter(server => server.urls.includes('stun:') && server.urls.includes('google'));
                    case 'auto':
                    default:
                        // استخدم خليطاً متوازناً
                        return iceServers;
                }
            }

            // تهيئة PeerJS مع إعدادات متقدمة
            initializePeer() {
                const iceServers = this.getIceServers();
                
                const config = {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    debug: 3, // زيادة مستوى التصحيح
                    config: {
                        iceServers: iceServers,
                        iceCandidatePoolSize: this.connectionMode === 'reliable' ? 20 : 10,
                        iceTransportPolicy: this.connectionMode === 'fast' ? 'relay' : 'all',
                        bundlePolicy: 'max-bundle',
                        rtcpMuxPolicy: 'require',
                        iceCandidatePoolSize: 10
                    },
                    sdpSemantics: 'unified-plan'
                };

                console.log('🔄 تهيئة PeerJS مع الإعدادات:', {
                    mode: this.connectionMode,
                    iceServersCount: iceServers.length,
                    config: config
                });

                this.peer = new Peer(this.myId, config);
                this.setupPeerEvents();
            }

            // إعداد أحداث PeerJS
            setupPeerEvents() {
                this.peer.on('open', (id) => {
                    console.log('✅ PeerJS متصل، المعرف:', id);
                    this.showNotification('success', 'جاهز للاتصال', `معرفك الحالي: ${id}`);
                    this.updateConnectionStatus('connected');
                    
                    // تحديث إحصائيات النجاح
                    this.connectionStats.successes++;
                    this.saveConnectionStats();
                });

                this.peer.on('connection', (conn) => {
                    console.log('📥 اتصال وارد من:', conn.peer);
                    this.handleIncomingConnection(conn);
                });

                this.peer.on('error', (err) => {
                    console.error('❌ خطأ في PeerJS:', err);
                    
                    // تحديث إحصائيات الفشل
                    this.connectionStats.failures++;
                    this.saveConnectionStats();
                    
                    // معالجة أخطاء محددة
                    switch(err.type) {
                        case 'unavailable-id':
                            this.showNotification('error', 'المعرف مستخدم', 'هذا المعرف مستخدم بالفعل، اختر معرفاً آخر');
                            // إنشاء معرف جديد تلقائياً
                            const newId = 'user-' + Math.random().toString(36).substr(2, 8);
                            this.saveMyId(newId);
                            this.showNotification('info', 'معرف جديد', `تم تعيين معرف جديد: ${newId}`);
                            break;
                            
                        case 'server-error':
                        case 'network':
                            this.showNotification('warning', 'مشكلة في الشبكة', 'جاري إعادة المحاولة مع خادم بديل...');
                            setTimeout(() => this.reconnectToServer(), 2000);
                            break;
                            
                        case 'peer-unavailable':
                            this.showNotification('warning', 'الشخص غير متاح', 'المستخدم غير متصل حالياً');
                            break;
                            
                        default:
                            this.showNotification('error', 'خطأ في الاتصال', err.message || 'خطأ غير معروف');
                    }
                    
                    this.updateConnectionStatus('disconnected');
                });

                this.peer.on('disconnected', () => {
                    console.log('⚠️ تم قطع الاتصال مع سيرفر PeerJS');
                    this.updateConnectionStatus('disconnected');
                    
                    // محاولة إعادة الاتصال بعد 2 ثواني
                    setTimeout(() => {
                        if (!this.peer.disconnected) return;
                        this.reconnectToServer();
                    }, 2000);
                });

                this.peer.on('close', () => {
                    console.log('🔒 تم إغلاق PeerJS');
                    this.updateConnectionStatus('disconnected');
                });
            }

            // إعادة الاتصال بالسيرفر
            reconnectToServer() {
                if (this.connectionAttempts >= this.maxConnectionAttempts) {
                    this.showNotification('error', 'فشل الاتصال', `تعذر الاتصال بعد ${this.maxConnectionAttempts} محاولات. جرب تغيير نوع الاتصال.`);
                    return;
                }

                this.connectionAttempts++;
                console.log(`🔄 محاولة إعادة الاتصال ${this.connectionAttempts}/${this.maxConnectionAttempts}`);
                
                // تغيير وضع الاتصال بعد عدة محاولات فاشلة
                if (this.connectionAttempts >= 3) {
                    this.cycleConnectionMode();
                }
                
                this.showNotification('info', 'إعادة الاتصال', `محاولة ${this.connectionAttempts} - وضع: ${this.getModeName(this.connectionMode)}`);
                
                setTimeout(() => {
                    this.peer.reconnect();
                }, 1000 * this.connectionAttempts); // زيادة التأخير مع كل محاولة
            }

            // تغيير وضع الاتصال تلقائياً
            cycleConnectionMode() {
                const modes = ['auto', 'reliable', 'fast'];
                const currentIndex = modes.indexOf(this.connectionMode);
                const nextIndex = (currentIndex + 1) % modes.length;
                this.connectionMode = modes[nextIndex];
                this.elements.connectionMode.value = this.connectionMode;
                
                this.showNotification('info', 'تغيير الإعدادات', `تم تغيير وضع الاتصال إلى: ${this.getModeName(this.connectionMode)}`);
                
                // إعادة تهيئة الاتصال مع الإعدادات الجديدة
                if (this.peer) {
                    this.peer.destroy();
                }
                this.initializePeer();
            }

            // معالجة الاتصالات الواردة
            handleIncomingConnection(conn) {
                console.log('🔗 معالجة اتصال وارد:', conn.peer);
                
                if (this.connection && this.connection.open) {
                    conn.close();
                    this.showNotification('warning', 'اتصال مرفوض', 'لديك اتصال نشط بالفعل');
                    return;
                }

                this.connection = conn;
                this.setupConnectionEvents();
                this.savePeerId(conn.peer);
                this.showNotification('info', 'اتصال وارد', `تم الاتصال من ${conn.peer}`);
                this.updateConnectionStatus('connecting');
            }

            // إعداد أحداث الاتصال
            setupConnectionEvents() {
                this.connection.on('open', () => {
                    console.log('🎉 اتصال مفتوح بنجاح!');
                    this.isConnected = true;
                    this.connectionAttempts = 0;
                    this.updateUI();
                    this.showNotification('success', 'تم الاتصال!', 'يمكنك البدء في المراسلة الآن');
                    this.updatePeerInfo();
                    this.updateConnectionStatus('connected');
                    
                    // إرسال رسالة ترحيب
                    this.sendWelcomeMessage();
                    
                    // بدء مراقبة الاتصال
                    this.startConnectionMonitor();
                    this.startPingMonitor();
                });

                this.connection.on('data', (data) => {
                    this.handleIncomingMessage(data);
                });

                this.connection.on('close', () => {
                    this.handleDisconnection();
                });

                this.connection.on('error', (err) => {
                    console.error('❌ خطأ في الاتصال:', err);
                    this.showNotification('error', 'خطأ في الاتصال', err.message || 'خطأ غير معروف');
                    this.handleDisconnection();
                });

                this.connection.on('iceStateChanged', (state) => {
                    console.log('🔄 حالة ICE تغيرت:', state);
                    this.elements.connState.textContent = this.translateIceState(state);
                    this.updateConnectionQuality();
                });

                this.connection.on('stream', (stream) => {
                    console.log('📹 تيار وسائط متاح:', stream);
                });
            }

            // إرسال رسالة ترحيب
            sendWelcomeMessage() {
                const welcomeMsg = {
                    type: 'system',
                    text: `مرحباً! تم الاتصال بنجاح. وضع الاتصال: ${this.getModeName(this.connectionMode)}`,
                    timestamp: new Date().toISOString(),
                    sender: 'system'
                };
                
                try {
                    this.connection.send(welcomeMsg);
                } catch (e) {
                    console.log('⚠️ لم نتمكن من إرسال رسالة الترحيب');
                }
            }

            // بدء مراقبة الاتصال
            startConnectionMonitor() {
                clearInterval(this.connectionMonitor);
                
                this.connectionMonitor = setInterval(() => {
                    if (this.connection && this.connection.open) {
                        this.updateConnectionMetrics();
                    } else {
                        clearInterval(this.connectionMonitor);
                    }
                }, 3000);
            }

            // بدء مراقبة ping
            startPingMonitor() {
                clearInterval(this.pingInterval);
                
                this.pingInterval = setInterval(() => {
                    if (this.connection && this.connection.open) {
                        this.lastPingTime = Date.now();
                        this.connection.send({ 
                            type: 'ping', 
                            timestamp: this.lastPingTime,
                            mode: this.connectionMode
                        });
                    } else {
                        clearInterval(this.pingInterval);
                    }
                }, 3000);
            }

            // تهيئة مستمعي الأحداث
            initializeEventListeners() {
                // حفظ المعرف الخاص
                this.elements.saveMyId.addEventListener('click', () => this.saveCurrentId());
                
                // زر الاتصال
                this.elements.connectBtn.addEventListener('click', () => this.connectToPeer());
                
                // زر قطع الاتصال
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                
                // مسح المحادثة
                this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());
                
                // اختبار الاتصال
                this.elements.testConnectionBtn.addEventListener('click', () => this.testConnection());
                
                // إرسال الرسالة
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // إرسال بالإنتر
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // فتح/إغلاق الإيموجي
                this.elements.emojiBtn.addEventListener('click', () => this.toggleEmojiPicker());
                
                // إغلاق الإيموجي عند النقر خارجها
                document.addEventListener('click', (e) => {
                    if (this.elements.emojiPicker && 
                        !this.elements.emojiPicker.contains(e.target) && 
                        !this.elements.emojiBtn.contains(e.target)) {
                        this.elements.emojiPicker.classList.remove('show');
                    }
                });
                
                // إعادة الاتصال
                this.elements.reconnectBtn.addEventListener('click', () => {
                    this.elements.reconnectBanner.style.display = 'none';
                    this.connectToPeer();
                });
                
                // تجاهل إعادة الاتصال
                this.elements.dismissReconnect.addEventListener('click', () => {
                    this.elements.reconnectBanner.style.display = 'none';
                });
            }

            // اختبار الاتصال
            testConnection() {
                if (!this.peer || this.peer.disconnected) {
                    this.showNotification('warning', 'غير متصل', 'الاتصال مع السيرفر غير نشط');
                    return;
                }
                
                this.showNotification('info', 'اختبار الاتصال', 'جاري اختبار اتصال السيرفر...');
                
                // اختبار بسيط
                const testId = 'test-' + Date.now();
                const testPeer = new Peer(testId, {
                    host: '0.peerjs.com',
                    port: 443,
                    secure: true,
                    debug: 0
                });
                
                testPeer.on('open', () => {
                    this.showNotification('success', 'اختبار ناجح', 'الاتصال مع السيرفر يعمل بشكل جيد');
                    testPeer.destroy();
                });
                
                testPeer.on('error', () => {
                    this.showNotification('error', 'اختبار فاشل', 'هناك مشكلة في الاتصال بالسيرفر');
                    testPeer.destroy();
                });
            }

            // حفظ المعرف الحالي
            saveCurrentId() {
                const newId = this.elements.myId.value.trim();
                
                if (!newId || newId === '') {
                    this.showNotification('warning', 'معرف مطلوب', 'الرجاء إدخال معرف');
                    return;
                }
                
                if (newId === this.myId) {
                    this.showNotification('info', 'المعرف نفسه', 'هذا هو المعرف الحالي بالفعل');
                    return;
                }
                
                if (this.isConnected) {
                    this.showNotification('warning', 'اتصال نشط', 'لا يمكن تغيير المعرف أثناء الاتصال');
                    return;
                }
                
                if (this.saveMyId(newId)) {
                    // إعادة تهيئة Peer
                    if (this.peer) {
                        this.peer.destroy();
                    }
                    this.initializePeer();
                    
                    this.showNotification('success', 'تم الحفظ', `تم حفظ المعرف "${newId}"`);
                    this.renderMyIdList();
                    
                    // إظهار قسم إدارة المعرفات
                    this.elements.myIdManagement.style.display = 'block';
                }
            }

            // تهيئة منتقي الإيموجي
            initializeEmojiPicker() {
                const emojis = ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
                              '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                              '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                              '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                              '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
                              '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
                              '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯',
                              '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐',
                              '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '😈',
                              '👿', '👹', '👺', '🤡', '💩', '👻', '💀', '☠️', '👽', '👾',
                              '🤖', '🎃', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿',
                              '😾', '👋', '🤚', '🖐', '✋', '🖖', '👌', '🤏', '✌️', '🤞',
                              '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍',
                              '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝',
                              '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦵', '🦿', '🦶', '👂',
                              '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋',
                              '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔'];

                const emojiGrid = this.elements.emojiPicker.querySelector('.emoji-grid');
                emojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item';
                    emojiItem.textContent = emoji;
                    emojiItem.addEventListener('click', () => this.insertEmoji(emoji));
                    emojiGrid.appendChild(emojiItem);
                });

                // زر إغلاق الإيموجي
                this.elements.emojiPicker.querySelector('.close-emoji').addEventListener('click', () => {
                    this.elements.emojiPicker.classList.remove('show');
                });
            }

            // محاولة إعادة الاتصال التلقائي
            attemptAutoReconnect() {
                const lastPeerId = localStorage.getItem('p2p_last_peer');
                const wasConnected = localStorage.getItem('p2p_was_connected') === 'true';
                
                if (lastPeerId && wasConnected) {
                    setTimeout(() => {
                        this.elements.reconnectBanner.style.display = 'flex';
                    }, 1000);
                }
            }

            // الاتصال بالشخص الآخر مع تحسينات
            async connectToPeer() {
                const peerId = this.elements.peerId.value.trim();
                
                if (!peerId) {
                    this.showNotification('warning', 'معرف مطلوب', 'الرجاء إدخال معرف الشخص الآخر');
                    return;
                }
                
                if (peerId === this.myId) {
                    this.showNotification('warning', 'خطأ', 'لا يمكنك الاتصال بنفسك');
                    return;
                }
                
                if (this.connection && this.connection.open) {
                    this.showNotification('warning', 'اتصال نشط', 'لديك اتصال نشط بالفعل');
                    return;
                }

                this.connectionStats.attempts++;
                this.saveConnectionStats();
                
                this.showNotification('info', 'جاري الاتصال...', 
                    `محاولة الاتصال بـ ${peerId}\nوضع الاتصال: ${this.getModeName(this.connectionMode)}`);
                
                this.updateConnectionStatus('connecting');
                
                // محاولات متعددة بأساليب مختلفة
                this.attemptConnection(peerId, 0);
            }

            // محاولة الاتصال مع إعادة المحاولة
            attemptConnection(peerId, attempt) {
                if (attempt >= 3) {
                    this.showNotification('error', 'فشل الاتصال', 'فشلت جميع محاولات الاتصال. جرب وضع اتصال مختلف.');
                    this.updateConnectionStatus('disconnected');
                    return;
                }

                const connectionOptions = this.getConnectionOptions(attempt);
                
                try {
                    console.log(`🔄 محاولة اتصال ${attempt + 1}/3`, connectionOptions);
                    
                    this.connection = this.peer.connect(peerId, connectionOptions);
                    
                    this.savePeerId(peerId);
                    this.setupConnectionEvents();
                    
                    // مهلة الاتصال (أطول للمحاولات المتأخرة)
                    const timeout = 10000 + (attempt * 5000);
                    this.reconnectTimeout = setTimeout(() => {
                        if (!this.isConnected && this.connection) {
                            console.log(`⏰ انتهت مهلة المحاولة ${attempt + 1}`);
                            this.connection.close();
                            this.connection = null;
                            
                            if (attempt < 2) {
                                this.showNotification('warning', 'إعادة المحاولة', `جاري المحاولة ${attempt + 2}...`);
                                setTimeout(() => this.attemptConnection(peerId, attempt + 1), 1000);
                            }
                        }
                    }, timeout);
                    
                } catch (error) {
                    console.error('❌ خطأ في الاتصال:', error);
                    
                    if (attempt < 2) {
                        this.showNotification('warning', 'إعادة المحاولة', `جاري المحاولة ${attempt + 2}...`);
                        setTimeout(() => this.attemptConnection(peerId, attempt + 1), 1000);
                    } else {
                        this.showNotification('error', 'فشل الاتصال', error.message || 'تعذر إنشاء اتصال');
                        this.updateConnectionStatus('disconnected');
                    }
                }
            }

            // الحصول على خيارات الاتصال حسب المحاولة
            getConnectionOptions(attempt) {
                const baseOptions = {
                    reliable: true,
                    serialization: 'json',
                    metadata: {
                        client: 'P2P Messenger',
                        version: '2.0',
                        timestamp: Date.now(),
                        myName: this.myId,
                        connectionMode: this.connectionMode,
                        attempt: attempt + 1
                    }
                };

                // تعديل الخيارات حسب المحاولة
                switch(attempt) {
                    case 0:
                        // المحاولة الأولى: إعدادات عادية
                        return baseOptions;
                    case 1:
                        // المحاولة الثانية: إعدادات أكثر موثوقية
                        return {
                            ...baseOptions,
                            reliable: true,
                            metadata: { ...baseOptions.metadata, fallback: true }
                        };
                    case 2:
                        // المحاولة الثالثة: إعدادات مبسطة
                        return {
                            ...baseOptions,
                            reliable: false, // قد يعمل أفضل في بعض الحالات
                            metadata: { ...baseOptions.metadata, simple: true }
                        };
                    default:
                        return baseOptions;
                }
            }

            // قطع الاتصال
            disconnect() {
                if (this.connection) {
                    this.connection.close();
                }
                this.handleDisconnection();
            }

            // معالجة قطع الاتصال
            handleDisconnection() {
                this.isConnected = false;
                this.connection = null;
                clearTimeout(this.reconnectTimeout);
                clearInterval(this.connectionMonitor);
                clearInterval(this.pingInterval);
                this.updateUI();
                this.showNotification('info', 'تم قطع الاتصال', 'تم إنهاء الاتصال مع الطرف الآخر');
                this.updateConnectionStatus('disconnected');
                localStorage.setItem('p2p_was_connected', 'false');
            }

            // إرسال رسالة
            sendMessage() {
                const messageText = this.elements.messageInput.value.trim();
                
                if (!messageText) {
                    this.showNotification('warning', 'رسالة فارغة', 'الرجاء كتابة رسالة');
                    return;
                }
                
                if (!this.isConnected || !this.connection || !this.connection.open) {
                    this.showNotification('error', 'غير متصل', 'لا يوجد اتصال نشط');
                    return;
                }

                const message = {
                    type: 'message',
                    text: messageText,
                    timestamp: new Date().toISOString(),
                    sender: this.myId,
                    messageId: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    connectionMode: this.connectionMode
                };

                try {
                    this.connection.send(message);
                    this.addMessage(message, 'sent');
                    this.elements.messageInput.value = '';
                    this.elements.messageInput.style.height = 'auto';
                    
                    // حفظ الرسائل
                    this.saveMessages();
                } catch (error) {
                    console.error('❌ خطأ في إرسال الرسالة:', error);
                    this.showNotification('error', 'فشل الإرسال', 'تعذر إرسال الرسالة. تحقق من الاتصال.');
                    
                    // محاولة إعادة الإرسال مرة واحدة
                    setTimeout(() => {
                        if (this.connection && this.connection.open) {
                            try {
                                this.connection.send(message);
                                this.addMessage(message, 'sent');
                                this.showNotification('success', 'تم الإرسال', 'تم إرسال الرسالة في المحاولة الثانية');
                            } catch (e) {
                                this.showNotification('error', 'فشل نهائي', 'تعذر إرسال الرسالة بعد محاولتين');
                            }
                        }
                    }, 1000);
                }
            }

            // معالجة الرسائل الواردة
            handleIncomingMessage(data) {
                if (data.type === 'message') {
                    this.addMessage(data, 'received');
                    this.saveMessages();
                } else if (data.type === 'ping') {
                    // الرد على ping
                    this.connection.send({ 
                        type: 'pong', 
                        timestamp: data.timestamp,
                        received: Date.now()
                    });
                } else if (data.type === 'pong') {
                    // حساب زمن الاستجابة
                    const latency = Date.now() - data.timestamp;
                    this.pingLatency = latency;
                    this.elements.connSpeed.textContent = `${latency}ms`;
                    this.updateConnectionQuality();
                    
                    // تحديث متوسط زمن الاستجابة
                    if (this.connectionStats.avgLatency === 0) {
                        this.connectionStats.avgLatency = latency;
                    } else {
                        this.connectionStats.avgLatency = (this.connectionStats.avgLatency + latency) / 2;
                    }
                    this.saveConnectionStats();
                } else if (data.type === 'system') {
                    // عرض رسائل النظام
                    this.showNotification('info', 'نظام', data.text);
                }
            }

            // إضافة رسالة إلى الواجهة
            addMessage(messageData, type) {
                // تجنب الرسائل المكررة
                if (this.messages.some(msg => msg.messageId === messageData.messageId)) {
                    return;
                }
                
                const message = {
                    ...messageData,
                    id: Date.now() + Math.random(),
                    type: type,
                    localTimestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.renderMessage(message);
                this.updateMessageCount();
                this.scrollToBottom();
                
                // إشعار عند استلام رسالة جديدة
                if (type === 'received') {
                    if (Notification.permission === 'granted') {
                        new Notification('رسالة جديدة', {
                            body: messageData.text.substring(0, 100),
                            icon: '/favicon.ico'
                        });
                    }
                    
                    this.showNotification('info', 'رسالة جديدة', messageData.text.substring(0, 50) + '...');
                }
            }

            // عرض الرسالة
            renderMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.type}`;
                messageElement.dataset.id = message.id;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // إضافة مؤشر وضع الاتصال للرسائل المرسلة
                const modeIndicator = message.type === 'sent' && message.connectionMode ? 
                    `<small style="opacity:0.7; font-size:0.7rem;">(${this.getModeName(message.connectionMode)})</small>` : '';
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        ${this.escapeHtml(message.text)}
                        <div class="message-time">
                            <i class="far fa-clock"></i>
                            ${time} ${modeIndicator}
                        </div>
                    </div>
                `;
                
                // إزالة رسالة الترحيب إذا كانت موجودة
                const welcomeMessage = this.elements.messagesContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.elements.messagesContainer.appendChild(messageElement);
            }

            // استعادة المحادثة من التخزين المحلي
            restoreChat() {
                try {
                    const savedMessages = localStorage.getItem('p2p_messages');
                    if (savedMessages) {
                        this.messages = JSON.parse(savedMessages);
                        this.messages.forEach(msg => this.renderMessage(msg));
                        this.updateMessageCount();
                    }
                } catch (error) {
                    console.error('❌ خطأ في استعادة المحادثة:', error);
                    localStorage.removeItem('p2p_messages');
                }
            }

            // حفظ الرسائل في التخزين المحلي
            saveMessages() {
                try {
                    // حفظ آخر 100 رسالة فقط لتجنب مشاكل التخزين
                    const messagesToSave = this.messages.slice(-100);
                    localStorage.setItem('p2p_messages', JSON.stringify(messagesToSave));
                } catch (error) {
                    console.error('❌ خطأ في حفظ الرسائل:', error);
                }
            }

            // تحديث واجهة المستخدم
            updateUI() {
                const isConnected = this.isConnected && this.connection && this.connection.open;
                
                // تحديث حالة الأزرار
                this.elements.connectBtn.disabled = isConnected;
                this.elements.disconnectBtn.disabled = !isConnected;
                this.elements.messageInput.disabled = !isConnected;
                this.elements.sendBtn.disabled = !isConnected;
                this.elements.saveMyId.disabled = isConnected;
                this.elements.myId.disabled = isConnected;
                this.elements.testConnectionBtn.disabled = isConnected;
                
                // تحديث معلومات الاتصال
                this.elements.connectionInfo.style.display = isConnected ? 'block' : 'none';
                
                if (isConnected) {
                    this.updateConnectionMetrics();
                }
            }

            // تحديث حالة الاتصال
            updateConnectionStatus(status) {
                const statusDot = this.elements.connectionStatus.querySelector('.status-dot');
                const statusText = this.elements.connectionStatus.querySelector('.status-text');
                
                statusDot.className = 'status-dot';
                
                switch(status) {
                    case 'connected':
                        statusDot.classList.add('connected');
                        statusText.textContent = 'متصل';
                        break;
                    case 'connecting':
                        statusDot.classList.add('connecting');
                        statusText.textContent = 'جاري الاتصال...';
                        break;
                    case 'disconnected':
                        statusText.textContent = 'غير متصل';
                        break;
                }
            }

            // تحديث جودة الاتصال
            updateConnectionQuality() {
                if (!this.pingLatency) return;
                
                let quality = 'جيدة';
                let color = '#2ed573';
                
                if (this.pingLatency < 100) {
                    quality = 'ممتازة';
                    color = '#2ed573';
                } else if (this.pingLatency < 300) {
                    quality = 'جيدة';
                    color = '#ffa502';
                } else if (this.pingLatency < 1000) {
                    quality = 'متوسطة';
                    color = '#ff7f00';
                } else {
                    quality = 'ضعيفة';
                    color = '#ff4757';
                }
                
                this.elements.connQuality.textContent = quality;
                this.elements.connQuality.style.color = color;
            }

            // تحديث معلومات الاتصال
            updateConnectionMetrics() {
                if (this.connection && this.peer) {
                    this.elements.connType.textContent = this.getModeName(this.connectionMode);
                    this.elements.connState.textContent = 'نشط';
                    
                    if (this.pingLatency) {
                        this.elements.connSpeed.textContent = `${this.pingLatency}ms`;
                        this.updateConnectionQuality();
                    }
                }
            }

            // تحديث معلومات الطرف الآخر
            updatePeerInfo() {
                if (this.connection) {
                    const shortId = this.connection.peer.length > 20 ? 
                        this.connection.peer.substring(0, 20) + '...' : 
                        this.connection.peer;
                    this.elements.peerName.textContent = `مستخدم: ${shortId}`;
                }
            }

            // تحديث عداد الرسائل
            updateMessageCount() {
                const count = this.messages.length;
                this.elements.messageCount.textContent = `${count} رسالة`;
            }

            // مسح المحادثة
            clearChat() {
                if (this.messages.length === 0) return;
                
                if (confirm('هل تريد مسح جميع الرسائل؟')) {
                    this.messages = [];
                    this.elements.messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <i class="fas fa-handshake"></i>
                            <h3>مرحبًا في منصة المراسلة المباشرة</h3>
                            <p>قم بالاتصال بشخص آخر لبدء المحادثة</p>
                        </div>
                    `;
                    this.updateMessageCount();
                    localStorage.removeItem('p2p_messages');
                    this.showNotification('success', 'تم المسح', 'تم مسح جميع الرسائل');
                }
            }

            // عرض الإشعارات
            showNotification(type, title, message) {
                const notificationArea = document.getElementById('notificationArea');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                notification.innerHTML = `
                    <i class="${icons[type]}"></i>
                    <div class="notification-content">
                        <h4>${title}</h4>
                        <p>${message}</p>
                    </div>
                `;
                
                notificationArea.appendChild(notification);
                
                // إزالة الإشعار بعد 3 ثوانٍ
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            // التمرير للأسفل
            scrollToBottom() {
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            // تحويل حالة ICE
            translateIceState(state) {
                const states = {
                    'new': 'جديد',
                    'checking': 'جاري التحقق',
                    'connected': 'متصل',
                    'completed': 'مكتمل',
                    'failed': 'فشل',
                    'disconnected': 'منقطع',
                    'closed': 'مغلق'
                };
                return states[state] || state;
            }

            // منع الثغرات الأمنية (HTML escaping)
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // إدراج إيموجي
            insertEmoji(emoji) {
                const input = this.elements.messageInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                
                input.value = text.substring(0, start) + emoji + text.substring(end);
                input.focus();
                input.selectionStart = input.selectionEnd = start + emoji.length;
                
                this.elements.emojiPicker.classList.remove('show');
            }

            // تبديل منتقي الإيموجي
            toggleEmojiPicker() {
                this.elements.emojiPicker.classList.toggle('show');
            }
        }

        // طلب إذن الإشعارات
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const app = new P2PMessenger();
            window.p2pMessenger = app; // لجعل التطبيق متاحًا في وحدة التحكم
            console.log('🚀 P2P Messenger المحسّن جاهز للاستخدام!');
            console.log('💡 نصائح: إذا واجهت مشاكل في الاتصال، جرب تغيير نوع الاتصال من القائمة.');
            
            // التحذير عند إغلاق الصفحة
            window.addEventListener('beforeunload', (e) => {
                if (app.isConnected) {
                    e.preventDefault();
                    e.returnValue = 'لديك اتصال نشط. هل تريد مغادرة الصفحة؟';
                }
            });
            
            // إعادة الاتصال عند العودة للصفحة
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && app.peer && app.peer.disconnected) {
                    console.log('🔄 إعادة الاتصال بعد العودة للصفحة');
                    app.peer.reconnect();
                }
            });
        });
    </script>
</body>
</html>