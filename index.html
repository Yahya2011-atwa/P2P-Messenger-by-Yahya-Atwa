<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة المراسلة المباشرة - Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========== CSS كامل ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --bg-color: #f5f7fb;
            --card-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* شريط العنوان */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4757;
            animation: pulse 2s infinite;
            position: relative;
        }

        .status-dot.connecting {
            background-color: #ffa502;
            animation: pulse-connecting 1s infinite;
        }

        .status-dot.connected {
            background-color: #2ed573;
            animation: pulse-connected 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-connecting {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(255, 165, 2, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(255, 165, 2, 0);
            }
        }

        @keyframes pulse-connected {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(46, 213, 115, 0);
            }
        }

        /* المحتوى الرئيسي */
        .app-main {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            flex: 1;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .app-main {
                grid-template-columns: 1fr;
            }
        }

        /* لوحة التحكم */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .panel-card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-with-button input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-with-button input:read-only {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        /* الأزرار */
        .btn-primary, .btn-secondary, .btn-icon, .btn-send {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            min-width: 120px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.2);
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-icon {
            padding: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
            width: 48px;
            height: 48px;
        }

        .btn-icon:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            padding: 12px 30px;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 201, 240, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        /* معلومات الاتصال */
        .connection-info {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed var(--border-color);
        }

        .connection-info h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .info-item:hover {
            transform: translateY(-3px);
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-color);
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--dark-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* التعليمات */
        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions ol {
            padding-right: 20px;
            margin-bottom: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            padding-right: 10px;
            position: relative;
        }

        .instructions li::before {
            content: '';
            position: absolute;
            right: -20px;
            top: 8px;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .features {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feature-tag {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #00695c;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s ease;
        }

        .feature-tag:hover {
            transform: scale(1.05);
        }

        /* منطقة المحادثة */
        .chat-section {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .peer-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .message-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* نافذة الرسائل */
        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #fafbfd;
            min-height: 400px;
            max-height: 60vh;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(0,0,0,0.05) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, rgba(0,0,0,0.05) 2px, transparent 0);
            background-size: 100px 100px;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }

        .welcome-message i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-message h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .welcome-message p {
            font-size: 1.1rem;
        }

        /* الرسائل الفردية */
        .message {
            margin-bottom: 20px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background: var(--light-color);
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.sent .message-time {
            text-align: left;
            color: var(--primary-color);
        }

        .message.received .message-time {
            text-align: right;
            color: var(--gray-color);
        }

        /* منطقة إدخال الرسالة */
        .message-input-area {
            padding: 25px;
            border-top: 2px solid var(--border-color);
            background: var(--card-color);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-container textarea:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .input-hint {
            text-align: center;
            margin-top: 10px;
            color: var(--gray-color);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        kbd {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        /* التذييل */
        .app-footer {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-top: auto;
            border: 1px solid var(--border-color);
        }

        .footer-content p {
            margin-bottom: 10px;
            color: var(--gray-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tech-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        /* الإشعارات */
        #notificationArea {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 350px;
            border-right: 4px solid var(--primary-color);
            transform-origin: left center;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-100%) scale(0.8); }
        }

        .notification.success {
            border-right-color: var(--success-color);
        }

        .notification.error {
            border-right-color: var(--danger-color);
        }

        .notification.warning {
            border-right-color: var(--warning-color);
        }

        .notification.info {
            border-right-color: var(--primary-color);
        }

        .notification i {
            font-size: 1.5rem;
        }

        .notification.success i {
            color: var(--success-color);
        }

        .notification.error i {
            color: var(--danger-color);
        }

        .notification.warning i {
            color: var(--warning-color);
        }

        .notification.info i {
            color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-content h4 {
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .notification-content p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        /* نافذة الإيموجي */
        .emoji-picker {
            position: fixed;
            bottom: 120px;
            left: 30px;
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .emoji-picker.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .emoji-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-header h4 {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .emoji-grid {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background: var(--light-color);
            transform: scale(1.2);
        }

        /* إعادة الاتصال */
        .reconnect-banner {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .reconnect-banner button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reconnect-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* قائمة الاقتراحات */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .suggestions-dropdown.show {
            display: block;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background-color: #f5f7fb;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .input-with-suggestions {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* مخصص للشاشات الصغيرة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .app-main {
                gap: 20px;
            }
            
            .panel-card, .chat-header, .message-input-area {
                padding: 15px;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .message {
                max-width: 90%;
            }
            
            .emoji-picker {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .reconnect-banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* تأثيرات التحميل */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* خيارات الخادم */
        .server-options {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
        }

        .server-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .server-option:hover {
            background: #e9ecef;
        }

        .server-option input {
            margin-left: 10px;
        }

        .server-option label {
            flex: 1;
            cursor: pointer;
        }

        .server-status {
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: #e9ecef;
        }

        .server-status.online {
            background: #d4edda;
            color: #155724;
        }

        .server-status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- شريط العنوان -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <h1>مراسلة المدارس</h1>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">غير متصل</span>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- لوحة التحكم -->
            <section class="control-panel">
                <div class="panel-card">
                    <h2><i class="fas fa-cogs"></i> إدارة الاتصال</h2>
                    
                    <div class="connection-controls">
                        <!-- خيارات الخادم -->
                        <div class="control-group">
                            <label><i class="fas fa-server"></i> اختر طريقة الاتصال</label>
                            <div class="server-options" id="serverOptions">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> إذا فشل اتصال، جرب خياراً آخر
                            </small>
                        </div>

                        <!-- معرفك الخاص -->
                        <div class="control-group">
                            <label for="myId"><i class="fas fa-fingerprint"></i> اسمك</label>
                            <div class="input-with-button">
                                <input type="text" id="myId" placeholder="أدخل اسمك">
                                <button id="saveMyId" class="btn-primary">
                                    <i class="fas fa-save"></i> حفظ
                                </button>
                            </div>
                        </div>

                        <!-- معرف الغرفة -->
                        <div class="control-group">
                            <label for="roomId"><i class="fas fa-door-open"></i> رقم الغرفة</label>
                            <div class="input-with-button">
                                <input type="text" id="roomId" placeholder="مثال: الصف الأول، الرياضيات، الخ..">
                                <button id="joinRoomBtn" class="btn-primary">
                                    <i class="fas fa-sign-in-alt"></i> دخول الغرفة
                                </button>
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-users"></i> كل من يدخل نفس رقم الغرفة سيرى رسائلك
                            </small>
                        </div>

                        <!-- الإجراءات -->
                        <div class="action-buttons">
                            <button id="disconnectBtn" class="btn-secondary" disabled>
                                <i class="fas fa-sign-out-alt"></i> مغادرة الغرفة
                            </button>
                            <button id="clearChatBtn" class="btn-secondary">
                                <i class="fas fa-trash"></i> مسح المحادثة
                            </button>
                            <button id="testConnectionBtn" class="btn-secondary">
                                <i class="fas fa-wifi"></i> فحص الاتصال
                            </button>
                        </div>

                        <!-- معلومات الاتصال -->
                        <div class="connection-info" id="connectionInfo" style="display: none;">
                            <h3><i class="fas fa-info-circle"></i> معلومات الاتصال</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">الحالة:</span>
                                    <span class="info-value" id="connState">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">الغرفة:</span>
                                    <span class="info-value" id="connRoom">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">المستخدمون:</span>
                                    <span class="info-value" id="connUsers">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">الرسائل:</span>
                                    <span class="info-value" id="connMessages">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- التعليمات -->
                <div class="panel-card instructions">
                    <h3><i class="fas fa-graduation-cap"></i> كيف تعمل في المدرسة؟</h3>
                    <ol>
                        <li><strong>اختر طريقة اتصال</strong> من القائمة (جرب جميع الخيارات)</li>
                        <li><strong>أدخل اسمك</strong> (مثال: أحمد، محمد، الطالب1)</li>
                        <li><strong>اختر رقم غرفة</strong> مشترك مع زملائك (مثال: الصف-10، الرياضيات، الفصل-أ)</li>
                        <li><strong>اطلب من زملائك</strong> استخدام نفس رقم الغرفة</li>
                        <li><strong>اكتب رسالتك</strong> وسيرى الجميع في نفس الغرفة</li>
                    </ol>
                    <div class="features">
                        <span class="feature-tag"><i class="fas fa-school"></i> للمدارس</span>
                        <span class="feature-tag"><i class="fas fa-shield-alt"></i> آمن</span>
                        <span class="feature-tag"><i class="fas fa-bolt"></i> فوري</span>
                        <span class="feature-tag"><i class="fas fa-users"></i> جماعي</span>
                    </div>
                </div>
            </section>

            <!-- منطقة المحادثة -->
            <section class="chat-section">
                <div class="chat-container">
                    <!-- رأس المحادثة -->
                    <div class="chat-header">
                        <h2><i class="fas fa-comment-dots"></i> المحادثة الجماعية</h2>
                        <div class="chat-info" id="chatInfo">
                            <span id="roomName" class="peer-name">لم يتم الانضمام لغرفة بعد</span>
                            <span class="message-count" id="messageCount">0 رسالة</span>
                        </div>
                    </div>

                    <!-- نافذة الرسائل -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="welcome-message">
                            <i class="fas fa-school"></i>
                            <h3>مرحبًا في مراسلة المدارس</h3>
                            <p>اختر طريقة اتصال، ثم ادخل اسمك ورقم الغرفة للبدء</p>
                            <div style="margin-top: 20px; color: var(--gray-color); font-size: 0.9rem;">
                                <i class="fas fa-tips"></i> هذا التطبيق يعمل في معظم شبكات المدارس
                            </div>
                        </div>
                    </div>

                    <!-- منطقة إدخال الرسالة -->
                    <div class="message-input-area">
                        <div class="input-container">
                            <textarea 
                                id="messageInput" 
                                placeholder="اكتب رسالتك هنا..." 
                                rows="2"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button id="sendBtn" class="btn-send" disabled>
                                    <i class="fas fa-paper-plane"></i> إرسال للجميع
                                </button>
                                <button id="emojiBtn" class="btn-icon" title="إيموجي">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-hint">
                            <i class="fas fa-keyboard"></i> اضغط <kbd>Enter</kbd> للإرسال، <kbd>Shift+Enter</kbd> لسطر جديد
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- التذييل -->
        <footer class="app-footer">
            <div class="footer-content">
                <p>
                    <i class="fas fa-code"></i> مبني خصيصاً للمدارس المصرية
                    <strong>يحيى محمد</strong> للتواصل <strong>20114165562+ </strong>
                </p>
                <p class="tech-badges">
                    <span class="badge">WebSocket</span>
                    <span class="badge">HTTP</span>
                    <span class="badge">Long Polling</span>
                    <span class="badge">Works Anywhere</span>
                </p>
            </div>
        </footer>

        <!-- الإشعارات -->
        <div id="notificationArea"></div>

        <!-- نافذة الإيموجي -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header">
                <h4>اختر إيموجي</h4>
                <button class="btn-icon close-emoji">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="emoji-grid">
                <!-- سيتم إضافة الإيموجي عبر JavaScript -->
            </div>
        </div>
    </div>

    <!-- كود JavaScript مدمج -->
    <script>
        // ========== نظام مراسلة يعمل في المدارس المصرية ==========
        class SchoolMessenger {
            constructor() {
                this.connection = null;
                this.myId = this.getOrCreateId();
                this.roomId = '';
                this.messages = [];
                this.users = new Set();
                this.isConnected = false;
                this.connectionType = 'websocket';
                this.serverUrl = '';
                this.pingInterval = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                
                // قائمة الخوادم المتاحة
                this.servers = [
                    {
                        id: 'websocket1',
                        name: 'اتصال مباشر (WebSocket)',
                        type: 'websocket',
                        url: 'wss://school-chat-server-1.onrender.com',
                        description: 'الأسرع والأفضل'
                    },
                    {
                        id: 'websocket2',
                        name: 'اتصال احتياطي',
                        type: 'websocket',
                        url: 'wss://simple-websocket-server.glitch.me',
                        description: 'بديل موثوق'
                    },
                    {
                        id: 'http1',
                        name: 'اتصال HTTP (يعمل في معظم المدارس)',
                        type: 'http',
                        url: 'https://school-chat-http.glitch.me',
                        description: 'ينجح في 90% من الحالات'
                    },
                    {
                        id: 'longpoll',
                        name: 'اتصال بطيء ولكن موثوق',
                        type: 'longpoll',
                        url: 'https://school-long-poll.glitch.me',
                        description: 'ينجح حتى مع أقوى الجدران النارية'
                    },
                    {
                        id: 'simulate',
                        name: 'وضع تجريبي (بدون إنترنت)',
                        type: 'simulate',
                        url: '',
                        description: 'للتجربة المحلية'
                    }
                ];

                this.initializeElements();
                this.initializeEventListeners();
                this.initializeEmojiPicker();
                this.restoreChat();
                this.updateUI();
                
                // اختيار خادم افتراضي
                this.selectServer('http1');
            }

            // الحصول على المعرف المخزن أو إنشاء جديد
            getOrCreateId() {
                let savedId = localStorage.getItem('school_messenger_my_id');
                
                if (!savedId) {
                    // أسماء عربية شائعة للطلاب
                    const arabicNames = ['أحمد', 'محمد', 'علي', 'خالد', 'مصطفى', 'يوسف', 'عمر', 'محمود', 'حسن', 'حسين', 
                                       'فاطمة', 'مريم', 'سارة', 'آية', 'نور', 'لمى', 'جنى', 'ريم', 'سما', 'شهد'];
                    const randomName = arabicNames[Math.floor(Math.random() * arabicNames.length)];
                    const randomNum = Math.floor(Math.random() * 100);
                    savedId = `${randomName}${randomNum}`;
                    
                    localStorage.setItem('school_messenger_my_id', savedId);
                }
                
                return savedId;
            }

            // تهيئة العناصر
            initializeElements() {
                this.elements = {
                    myId: document.getElementById('myId'),
                    roomId: document.getElementById('roomId'),
                    saveMyId: document.getElementById('saveMyId'),
                    joinRoomBtn: document.getElementById('joinRoomBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    clearChatBtn: document.getElementById('clearChatBtn'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectionInfo: document.getElementById('connectionInfo'),
                    connState: document.getElementById('connState'),
                    connRoom: document.getElementById('connRoom'),
                    connUsers: document.getElementById('connUsers'),
                    connMessages: document.getElementById('connMessages'),
                    chatInfo: document.getElementById('chatInfo'),
                    roomName: document.getElementById('roomName'),
                    messageCount: document.getElementById('messageCount'),
                    emojiBtn: document.getElementById('emojiBtn'),
                    emojiPicker: document.getElementById('emojiPicker'),
                    serverOptions: document.getElementById('serverOptions'),
                    testConnectionBtn: document.getElementById('testConnectionBtn')
                };

                this.elements.myId.value = this.myId;
                this.renderServerOptions();
                
                // تحميل آخر غرفة
                const lastRoom = localStorage.getItem('school_last_room');
                if (lastRoom) {
                    this.elements.roomId.value = lastRoom;
                }
            }

            // عرض خيارات الخوادم
            renderServerOptions() {
                this.elements.serverOptions.innerHTML = '';
                
                this.servers.forEach(server => {
                    const option = document.createElement('div');
                    option.className = 'server-option';
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'server-status';
                    statusSpan.textContent = 'جاري الفحص...';
                    statusSpan.id = `status-${server.id}`;
                    
                    option.innerHTML = `
                        <input type="radio" name="server" id="${server.id}" value="${server.id}">
                        <label for="${server.id}">
                            <strong>${server.name}</strong><br>
                            <small style="color: var(--gray-color);">${server.description}</small>
                        </label>
                    `;
                    
                    option.querySelector('input').addEventListener('change', (e) => {
                        if (e.target.checked) {
                            this.selectServer(server.id);
                        }
                    });
                    
                    option.appendChild(statusSpan);
                    this.elements.serverOptions.appendChild(option);
                    
                    // اختبار الخادم
                    this.testServer(server);
                });
            }

            // اختبار خادم
            async testServer(server) {
                const statusElement = document.getElementById(`status-${server.id}`);
                
                try {
                    if (server.type === 'simulate') {
                        statusElement.textContent = 'جاهز';
                        statusElement.className = 'server-status online';
                        return;
                    }
                    
                    if (server.type === 'websocket') {
                        // اختبار WebSocket
                        const testWs = new WebSocket(server.url);
                        
                        testWs.onopen = () => {
                            statusElement.textContent = 'متصل';
                            statusElement.className = 'server-status online';
                            testWs.close();
                        };
                        
                        testWs.onerror = () => {
                            statusElement.textContent = 'غير متصل';
                            statusElement.className = 'server-status offline';
                        };
                        
                        setTimeout(() => {
                            if (testWs.readyState !== WebSocket.OPEN) {
                                statusElement.textContent = 'غير متصل';
                                statusElement.className = 'server-status offline';
                            }
                        }, 3000);
                        
                    } else if (server.type === 'http' || server.type === 'longpoll') {
                        // اختبار HTTP
                        const response = await fetch(`${server.url}/health`, {
                            method: 'GET',
                            mode: 'cors',
                            timeout: 5000
                        }).catch(() => null);
                        
                        if (response && response.ok) {
                            statusElement.textContent = 'متصل';
                            statusElement.className = 'server-status online';
                        } else {
                            statusElement.textContent = 'غير متصل';
                            statusElement.className = 'server-status offline';
                        }
                    }
                } catch (error) {
                    statusElement.textContent = 'خطأ في الاتصال';
                    statusElement.className = 'server-status offline';
                }
            }

            // اختيار خادم
            selectServer(serverId) {
                const server = this.servers.find(s => s.id === serverId);
                if (!server) return;
                
                this.connectionType = server.type;
                this.serverUrl = server.url;
                this.currentServer = server;
                
                this.showNotification('info', 'تم التحديد', `طريقة الاتصال: ${server.name}`);
                
                // إذا كان متصلاً بالفعل، أعد الاتصال
                if (this.isConnected && this.roomId) {
                    this.disconnect();
                    setTimeout(() => this.joinRoom(), 1000);
                }
            }

            // اختبار الاتصال الحالي
            async testCurrentConnection() {
                if (!this.currentServer) {
                    this.showNotification('warning', 'لا يوجد خادم', 'اختر خادم أولاً');
                    return;
                }
                
                this.showNotification('info', 'جاري فحص الاتصال', `جاري فحص ${this.currentServer.name}...`);
                
                try {
                    if (this.currentServer.type === 'websocket') {
                        const testWs = new WebSocket(this.currentServer.url);
                        
                        await new Promise((resolve, reject) => {
                            testWs.onopen = () => {
                                testWs.close();
                                resolve();
                            };
                            testWs.onerror = reject;
                            setTimeout(reject, 5000);
                        });
                        
                        this.showNotification('success', 'الاتصال ناجح', 'الخادم يعمل بشكل ممتاز');
                        
                    } else if (this.currentServer.type === 'http' || this.currentServer.type === 'longpoll') {
                        const response = await fetch(`${this.currentServer.url}/health`, {
                            method: 'GET',
                            mode: 'cors'
                        });
                        
                        if (response.ok) {
                            this.showNotification('success', 'الاتصال ناجح', 'الخادم يعمل بشكل ممتاز');
                        } else {
                            throw new Error('الخادم لا يستجيب');
                        }
                    } else if (this.currentServer.type === 'simulate') {
                        this.showNotification('success', 'الوضع التجريبي', 'جاهز للاستخدام محلياً');
                    }
                } catch (error) {
                    this.showNotification('error', 'فشل الاتصال', 'الخادم غير متاح، جرب خادماً آخر');
                    // اختيار خادم تلقائي
                    const onlineServer = this.servers.find(s => {
                        const statusEl = document.getElementById(`status-${s.id}`);
                        return statusEl && statusEl.classList.contains('online') && s.id !== serverId;
                    });
                    
                    if (onlineServer) {
                        setTimeout(() => {
                            this.selectServer(onlineServer.id);
                            document.getElementById(onlineServer.id).checked = true;
                        }, 1000);
                    }
                }
            }

            // تهيئة مستمعي الأحداث
            initializeEventListeners() {
                // حفظ الاسم
                this.elements.saveMyId.addEventListener('click', () => this.saveMyName());
                
                // دخول الغرفة
                this.elements.joinRoomBtn.addEventListener('click', () => this.joinRoom());
                
                // مغادرة الغرفة
                this.elements.disconnectBtn.addEventListener('click', () => this.leaveRoom());
                
                // مسح المحادثة
                this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());
                
                // اختبار الاتصال
                this.elements.testConnectionBtn.addEventListener('click', () => this.testCurrentConnection());
                
                // إرسال الرسالة
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // إرسال بالإنتر
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // فتح/إغلاق الإيموجي
                this.elements.emojiBtn.addEventListener('click', () => this.toggleEmojiPicker());
                
                // إغلاق الإيموجي عند النقر خارجها
                document.addEventListener('click', (e) => {
                    if (this.elements.emojiPicker && 
                        !this.elements.emojiPicker.contains(e.target) && 
                        !this.elements.emojiBtn.contains(e.target)) {
                        this.elements.emojiPicker.classList.remove('show');
                    }
                });
            }

            // حفظ الاسم
            saveMyName() {
                const newName = this.elements.myId.value.trim();
                
                if (!newName || newName === '') {
                    this.showNotification('warning', 'اسم مطلوب', 'الرجاء إدخال اسم');
                    return;
                }
                
                this.myId = newName;
                localStorage.setItem('school_messenger_my_id', newName);
                this.showNotification('success', 'تم الحفظ', `اسمك الآن: ${newName}`);
            }

            // الانضمام للغرفة
            async joinRoom() {
                const roomId = this.elements.roomId.value.trim();
                
                if (!roomId) {
                    this.showNotification('warning', 'رقم غرفة مطلوب', 'الرجاء إدخال رقم الغرفة');
                    return;
                }
                
                if (!this.currentServer) {
                    this.showNotification('warning', 'اختر خادم', 'الرجاء اختيار طريقة اتصال أولاً');
                    return;
                }
                
                this.roomId = roomId;
                localStorage.setItem('school_last_room', roomId);
                
                this.showNotification('info', 'جاري الاتصال', `جاري الانضمام للغرفة: ${roomId}`);
                this.updateConnectionStatus('connecting');
                
                try {
                    await this.connectToServer();
                    this.isConnected = true;
                    this.updateUI();
                    
                    // إرسال رسالة انضمام
                    this.sendSystemMessage(`${this.myId} انضم للغرفة`);
                    
                    this.showNotification('success', 'تم الانضمام', `أنت الآن في غرفة: ${roomId}`);
                    this.updateConnectionStatus('connected');
                    
                } catch (error) {
                    console.error('❌ فشل الاتصال:', error);
                    this.showNotification('error', 'فشل الاتصال', 'تعذر الانضمام للغرفة، جرب خادماً آخر');
                    this.updateConnectionStatus('disconnected');
                    
                    // محاولة تلقائية مع خادم آخر
                    this.autoSwitchServer();
                }
            }

            // الاتصال بالخادم
            async connectToServer() {
                if (this.connection) {
                    this.disconnectFromServer();
                }
                
                this.reconnectAttempts = 0;
                
                switch(this.connectionType) {
                    case 'websocket':
                        return await this.connectWebSocket();
                    case 'http':
                        return await this.connectHTTP();
                    case 'longpoll':
                        return await this.connectLongPoll();
                    case 'simulate':
                        return this.connectSimulate();
                    default:
                        throw new Error('نوع اتصال غير معروف');
                }
            }

            // الاتصال عبر WebSocket
            connectWebSocket() {
                return new Promise((resolve, reject) => {
                    try {
                        const wsUrl = `${this.serverUrl}/ws?room=${this.roomId}&user=${this.myId}`;
                        this.connection = new WebSocket(wsUrl);
                        
                        this.connection.onopen = () => {
                            console.log('✅ WebSocket متصل');
                            this.startPing();
                            resolve();
                        };
                        
                        this.connection.onmessage = (event) => {
                            this.handleIncomingMessage(JSON.parse(event.data));
                        };
                        
                        this.connection.onerror = (error) => {
                            console.error('❌ WebSocket error:', error);
                            reject(error);
                        };
                        
                        this.connection.onclose = () => {
                            console.log('🔒 WebSocket مغلق');
                            this.handleDisconnection();
                        };
                        
                        // مهلة الاتصال
                        setTimeout(() => {
                            if (this.connection.readyState !== WebSocket.OPEN) {
                                reject(new Error('انتهت مهلة الاتصال'));
                            }
                        }, 10000);
                        
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            // الاتصال عبر HTTP (Long Polling محسن)
            connectHTTP() {
                return new Promise((resolve) => {
                    console.log('🔄 استخدام HTTP Long Polling');
                    
                    this.connection = {
                        type: 'http',
                        room: this.roomId,
                        user: this.myId,
                        active: true
                    };
                    
                    // بدء استقبال الرسائل
                    this.startHTTPPolling();
                    
                    // إرسال رسالة انضمام
                    this.sendHTTPMessage({
                        type: 'join',
                        user: this.myId,
                        room: this.roomId,
                        timestamp: Date.now()
                    }).then(() => {
                        resolve();
                    }).catch(() => {
                        // حتى لو فشل الإرسال الأول، نستمر
                        resolve();
                    });
                });
            }

            // بدء استقبال الرسائل عبر HTTP
            startHTTPPolling() {
                if (!this.connection || !this.connection.active) return;
                
                const poll = async () => {
                    if (!this.connection || !this.connection.active) return;
                    
                    try {
                        const response = await fetch(`${this.serverUrl}/poll?room=${this.roomId}&user=${this.myId}&last=${this.lastMessageTime || 0}`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json'
                            },
                            signal: AbortSignal.timeout(30000) // 30 ثانية مهلة
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.messages) {
                                data.messages.forEach(msg => this.handleIncomingMessage(msg));
                            }
                            if (data.users) {
                                this.updateUsersList(data.users);
                            }
                        }
                        
                        // الاستمرار في الاستقبال
                        setTimeout(poll, 100);
                        
                    } catch (error) {
                        if (error.name !== 'AbortError' && this.connection && this.connection.active) {
                            console.log('🔄 إعادة محاولة استقبال...');
                            setTimeout(poll, 1000);
                        }
                    }
                };
                
                poll();
            }

            // إرسال رسالة عبر HTTP
            async sendHTTPMessage(message) {
                try {
                    const response = await fetch(`${this.serverUrl}/send`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...message,
                            room: this.roomId,
                            user: this.myId
                        })
                    });
                    
                    return response.ok;
                } catch (error) {
                    console.error('❌ فشل إرسال HTTP:', error);
                    return false;
                }
            }

            // الاتصال عبر Long Polling التقليدي
            connectLongPoll() {
                // مشابه لـ HTTP ولكن مع مهلات أطول
                return this.connectHTTP();
            }

            // الاتصال المحاكى (بدون إنترنت)
            connectSimulate() {
                console.log('🎮 تشغيل الوضع التجريبي');
                
                this.connection = {
                    type: 'simulate',
                    room: this.roomId,
                    user: this.myId,
                    active: true
                };
                
                // إضافة بعض المستخدمين الوهميين
                setTimeout(() => {
                    this.updateUsersList([this.myId, 'محمد', 'أحمد', 'فاطمة']);
                    this.addSystemMessage('3 طلاب آخرون في الغرفة (وضع تجريبي)');
                }, 1000);
                
                return Promise.resolve();
            }

            // التحويل التلقائي بين الخوادم
            autoSwitchServer() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) return;
                
                this.reconnectAttempts++;
                
                // البحث عن خادم متصل
                const onlineServer = this.servers.find(s => {
                    const statusEl = document.getElementById(`status-${s.id}`);
                    return statusEl && statusEl.classList.contains('online') && s.id !== this.currentServer?.id;
                });
                
                if (onlineServer) {
                    this.showNotification('info', 'جرب خادماً آخر', `جاري التبديل إلى ${onlineServer.name}...`);
                    
                    setTimeout(() => {
                        this.selectServer(onlineServer.id);
                        document.getElementById(onlineServer.id).checked = true;
                        
                        if (this.roomId) {
                            setTimeout(() => this.joinRoom(), 500);
                        }
                    }, 1000);
                }
            }

            // بدء إرسال ping
            startPing() {
                if (this.pingInterval) clearInterval(this.pingInterval);
                
                this.pingInterval = setInterval(() => {
                    if (this.connection && this.connection.readyState === WebSocket.OPEN) {
                        this.connection.send(JSON.stringify({
                            type: 'ping',
                            timestamp: Date.now()
                        }));
                    }
                }, 30000);
            }

            // معالجة الرسائل الواردة
            handleIncomingMessage(data) {
                this.lastMessageTime = Date.now();
                
                switch(data.type) {
                    case 'message':
                        this.addMessage(data, 'received');
                        break;
                    case 'system':
                        this.addSystemMessage(data.text);
                        break;
                    case 'users':
                        this.updateUsersList(data.users);
                        break;
                    case 'ping':
                        // الرد على ping
                        if (this.connection && this.connection.readyState === WebSocket.OPEN) {
                            this.connection.send(JSON.stringify({
                                type: 'pong',
                                timestamp: data.timestamp
                            }));
                        }
                        break;
                }
                
                this.saveMessages();
            }

            // إرسال رسالة
            async sendMessage() {
                const messageText = this.elements.messageInput.value.trim();
                
                if (!messageText) {
                    this.showNotification('warning', 'رسالة فارغة', 'الرجاء كتابة رسالة');
                    return;
                }
                
                if (!this.isConnected) {
                    this.showNotification('error', 'غير متصل', 'أنت لست في غرفة');
                    return;
                }

                const message = {
                    type: 'message',
                    text: messageText,
                    timestamp: Date.now(),
                    user: this.myId,
                    room: this.roomId,
                    messageId: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                };

                // إضافة الرسالة محلياً أولاً
                this.addMessage(message, 'sent');
                this.elements.messageInput.value = '';
                this.elements.messageInput.style.height = 'auto';
                
                // إرسال الرسالة حسب نوع الاتصال
                let sendSuccess = false;
                
                try {
                    if (this.connectionType === 'websocket' && this.connection.readyState === WebSocket.OPEN) {
                        this.connection.send(JSON.stringify(message));
                        sendSuccess = true;
                    } else if (this.connectionType === 'http' || this.connectionType === 'longpoll') {
                        sendSuccess = await this.sendHTTPMessage(message);
                    } else if (this.connectionType === 'simulate') {
                        // في الوضع التجريبي، نضيف رداً وهمياً
                        setTimeout(() => {
                            this.addMessage({
                                type: 'message',
                                text: `رد على: ${messageText}`,
                                timestamp: Date.now() + 1000,
                                user: 'مستخدم تجريبي',
                                messageId: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                            }, 'received');
                        }, 1000);
                        sendSuccess = true;
                    }
                    
                    if (!sendSuccess) {
                        this.showNotification('warning', 'تحذير', 'تم حفظ الرسالة محلياً ولكن لم تصل للآخرين');
                    }
                    
                } catch (error) {
                    console.error('❌ فشل إرسال الرسالة:', error);
                    this.showNotification('error', 'فشل الإرسال', 'تعذر إرسال الرسالة، تحقق من الاتصال');
                }
                
                this.saveMessages();
            }

            // إرسال رسالة نظام
            sendSystemMessage(text) {
                const systemMessage = {
                    type: 'system',
                    text: text,
                    timestamp: Date.now(),
                    user: 'system'
                };
                
                this.handleIncomingMessage(systemMessage);
            }

            // إضافة رسالة للواجهة
            addMessage(messageData, type) {
                // تجنب الرسائل المكررة
                if (this.messages.some(msg => msg.messageId === messageData.messageId)) {
                    return;
                }
                
                const message = {
                    ...messageData,
                    id: Date.now() + Math.random(),
                    type: type,
                    localTimestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.renderMessage(message);
                this.updateMessageCount();
                this.scrollToBottom();
            }

            // إضافة رسالة نظام
            addSystemMessage(text) {
                const message = {
                    type: 'system',
                    text: text,
                    timestamp: Date.now(),
                    id: Date.now() + Math.random(),
                    localTimestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.renderSystemMessage(message);
                this.updateMessageCount();
                this.scrollToBottom();
            }

            // عرض رسالة عادية
            renderMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.type}`;
                messageElement.dataset.id = message.id;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const isSent = message.type === 'sent';
                const senderName = isSent ? 'أنت' : message.user || 'مستخدم';
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        <small style="opacity: 0.7; display: block; margin-bottom: 5px; font-weight: bold;">
                            ${senderName}
                        </small>
                        ${this.escapeHtml(message.text)}
                        <div class="message-time">
                            <i class="far fa-clock"></i>
                            ${time}
                        </div>
                    </div>
                `;
                
                // إزالة رسالة الترحيب إذا كانت موجودة
                const welcomeMessage = this.elements.messagesContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.elements.messagesContainer.appendChild(messageElement);
            }

            // عرض رسالة نظام
            renderSystemMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message system';
                messageElement.style.textAlign = 'center';
                messageElement.style.maxWidth = '100%';
                messageElement.style.margin = '10px auto';
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div style="
                        background: #e3f2fd;
                        color: #1565c0;
                        padding: 8px 15px;
                        border-radius: 20px;
                        display: inline-block;
                        font-size: 0.9rem;
                        border: 1px solid #bbdefb;
                    ">
                        <i class="fas fa-info-circle"></i>
                        ${this.escapeHtml(message.text)}
                        <small style="margin-right: 10px; opacity: 0.7;">
                            ${time}
                        </small>
                    </div>
                `;
                
                this.elements.messagesContainer.appendChild(messageElement);
            }

            // تحديث قائمة المستخدمين
            updateUsersList(users) {
                this.users = new Set(users);
                this.elements.connUsers.textContent = this.users.size;
                
                // إرسال إشعار عند دخول مستخدم جديد
                if (this.users.size > 1) {
                    this.elements.roomName.textContent = `غرفة: ${this.roomId} (${this.users.size} مستخدمين)`;
                }
            }

            // مغادرة الغرفة
            leaveRoom() {
                this.disconnectFromServer();
                this.isConnected = false;
                this.roomId = '';
                this.users.clear();
                this.updateUI();
                
                this.sendSystemMessage('غادرت الغرفة');
                this.showNotification('info', 'تم المغادرة', 'غادرت الغرفة بنجاح');
                this.updateConnectionStatus('disconnected');
            }

            // قطع الاتصال من الخادم
            disconnectFromServer() {
                if (this.pingInterval) {
                    clearInterval(this.pingInterval);
                    this.pingInterval = null;
                }
                
                if (this.connection) {
                    if (this.connectionType === 'websocket' && this.connection.readyState === WebSocket.OPEN) {
                        this.connection.close();
                    } else if (this.connection.type === 'http' || this.connection.type === 'longpoll') {
                        this.connection.active = false;
                    }
                    this.connection = null;
                }
                
                this.handleDisconnection();
            }

            // معالجة قطع الاتصال
            handleDisconnection() {
                this.isConnected = false;
                this.updateUI();
            }

            // استعادة المحادثة من التخزين المحلي
            restoreChat() {
                try {
                    const savedMessages = localStorage.getItem('school_messages');
                    if (savedMessages) {
                        this.messages = JSON.parse(savedMessages);
                        this.messages.forEach(msg => {
                            if (msg.type === 'system') {
                                this.renderSystemMessage(msg);
                            } else {
                                this.renderMessage(msg);
                            }
                        });
                        this.updateMessageCount();
                    }
                } catch (error) {
                    console.error('❌ خطأ في استعادة المحادثة:', error);
                    localStorage.removeItem('school_messages');
                }
            }

            // حفظ الرسائل في التخزين المحلي
            saveMessages() {
                try {
                    // حفظ آخر 100 رسالة فقط
                    const messagesToSave = this.messages.slice(-100);
                    localStorage.setItem('school_messages', JSON.stringify(messagesToSave));
                } catch (error) {
                    console.error('❌ خطأ في حفظ الرسائل:', error);
                }
            }

            // تحديث واجهة المستخدم
            updateUI() {
                const isConnected = this.isConnected;
                
                // تحديث حالة الأزرار
                this.elements.joinRoomBtn.disabled = isConnected;
                this.elements.disconnectBtn.disabled = !isConnected;
                this.elements.messageInput.disabled = !isConnected;
                this.elements.sendBtn.disabled = !isConnected;
                this.elements.myId.disabled = isConnected;
                this.elements.roomId.disabled = isConnected;
                this.elements.saveMyId.disabled = isConnected;
                
                // تحديث معلومات الاتصال
                this.elements.connectionInfo.style.display = isConnected ? 'block' : 'none';
                
                if (isConnected) {
                    this.elements.connState.textContent = 'متصل';
                    this.elements.connRoom.textContent = this.roomId;
                    this.elements.connMessages.textContent = this.messages.length;
                    this.elements.roomName.textContent = `غرفة: ${this.roomId}`;
                }
            }

            // تحديث حالة الاتصال
            updateConnectionStatus(status) {
                const statusDot = this.elements.connectionStatus.querySelector('.status-dot');
                const statusText = this.elements.connectionStatus.querySelector('.status-text');
                
                statusDot.className = 'status-dot';
                
                switch(status) {
                    case 'connected':
                        statusDot.classList.add('connected');
                        statusText.textContent = 'متصل';
                        break;
                    case 'connecting':
                        statusDot.classList.add('connecting');
                        statusText.textContent = 'جاري الاتصال...';
                        break;
                    case 'disconnected':
                        statusText.textContent = 'غير متصل';
                        break;
                }
            }

            // تحديث عداد الرسائل
            updateMessageCount() {
                const count = this.messages.length;
                this.elements.messageCount.textContent = `${count} رسالة`;
                this.elements.connMessages.textContent = count;
            }

            // مسح المحادثة
            clearChat() {
                if (this.messages.length === 0) return;
                
                if (confirm('هل تريد مسح جميع الرسائل؟')) {
                    this.messages = [];
                    this.elements.messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <i class="fas fa-school"></i>
                            <h3>مرحبًا في مراسلة المدارس</h3>
                            <p>اختر طريقة اتصال، ثم ادخل اسمك ورقم الغرفة للبدء</p>
                        </div>
                    `;
                    this.updateMessageCount();
                    localStorage.removeItem('school_messages');
                    this.showNotification('success', 'تم المسح', 'تم مسح جميع الرسائل');
                }
            }

            // تهيئة منتقي الإيموجي
            initializeEmojiPicker() {
                const emojis = ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇',
                              '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚',
                              '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩',
                              '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣',
                              '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬',
                              '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗',
                              '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯',
                              '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐',
                              '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕', '🤑', '🤠', '😈',
                              '👿', '👹', '👺', '🤡', '💩', '👻', '💀', '☠️', '👽', '👾',
                              '🤖', '🎃', '😺', '😸', '😹', '😻', '😼', '😽', '🙀', '😿',
                              '😾', '👋', '🤚', '🖐', '✋', '🖖', '👌', '🤏', '✌️', '🤞',
                              '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍',
                              '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝',
                              '🙏', '✍️', '💅', '🤳', '💪', '🦾', '🦵', '🦿', '🦶', '👂',
                              '🦻', '👃', '🧠', '🦷', '🦴', '👀', '👁️', '👅', '👄', '💋',
                              '❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔'];

                const emojiGrid = this.elements.emojiPicker.querySelector('.emoji-grid');
                emojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item';
                    emojiItem.textContent = emoji;
                    emojiItem.addEventListener('click', () => this.insertEmoji(emoji));
                    emojiGrid.appendChild(emojiItem);
                });

                // زر إغلاق الإيموجي
                this.elements.emojiPicker.querySelector('.close-emoji').addEventListener('click', () => {
                    this.elements.emojiPicker.classList.remove('show');
                });
            }

            // إدراج إيموجي
            insertEmoji(emoji) {
                const input = this.elements.messageInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                
                input.value = text.substring(0, start) + emoji + text.substring(end);
                input.focus();
                input.selectionStart = input.selectionEnd = start + emoji.length;
                
                this.elements.emojiPicker.classList.remove('show');
            }

            // تبديل منتقي الإيموجي
            toggleEmojiPicker() {
                this.elements.emojiPicker.classList.toggle('show');
            }

            // عرض الإشعارات
            showNotification(type, title, message) {
                const notificationArea = document.getElementById('notificationArea');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                notification.innerHTML = `
                    <i class="${icons[type]}"></i>
                    <div class="notification-content">
                        <h4>${title}</h4>
                        <p>${message}</p>
                    </div>
                `;
                
                notificationArea.appendChild(notification);
                
                // إزالة الإشعار بعد 3 ثوانٍ
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            // التمرير للأسفل
            scrollToBottom() {
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            // منع الثغرات الأمنية
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            const app = new SchoolMessenger();
            window.schoolMessenger = app;
            console.log('🏫 School Messenger جاهز للاستخدام!');
            
            // طلب إذن الإشعارات
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // رسالة ترحيب
            setTimeout(() => {
                app.showNotification('info', 'مرحباً!', 'هذا التطبيق مصمم خصيصاً للعمل في المدارس المصرية');
            }, 1000);
        });
    </script>
</body>
</html>