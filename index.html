<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
        .header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .header .user-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .user-code {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 10px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
        }

        .status-dot.connected {
            background: #2ed573;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .control-panel {
            width: 300px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
            padding: 20px;
            overflow-y: auto;
        }

        .panel-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .panel-section h3 {
            color: #4361ee;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #4361ee;
        }

        .button {
            width: 100%;
            padding: 12px;
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .button:hover {
            background: #3a0ca3;
        }

        .button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.success {
            background: #28a745;
        }

        .button.danger {
            background: #dc3545;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.sent .message-content {
            background: #4361ee;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background: white;
            color: #333;
            border: 1px solid #dee2e6;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .message.received .message-time {
            text-align: left;
        }

        /* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .message-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        .input-container textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            min-height: 50px;
            max-height: 120px;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: #4361ee;
        }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .login-box h2 {
            color: #4361ee;
            margin-bottom: 10px;
        }

        .login-box p {
            color: #6c757d;
            margin-bottom: 30px;
        }

        .code-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px dashed #4361ee;
        }

        .code-display .code {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4361ee;
            letter-spacing: 3px;
            font-family: monospace;
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1001;
            animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
            border-right: 4px solid #4361ee;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-100%); }
        }

        .notification.success {
            border-right-color: #28a745;
        }

        .notification.error {
            border-right-color: #dc3545;
        }

        .notification.info {
            border-right-color: #17a2b8;
        }

        /* Ù„Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .control-panel {
                width: 100%;
                border-left: none;
                border-bottom: 1px solid #dee2e6;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <h2>ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
            <p>Ø§Ø¯Ø®Ù„ ÙƒÙˆØ¯Ø§Ù‹ Ø´Ø®ØµÙŠØ§Ù‹ Ù„Ù„Ø¨Ø¯Ø¡</p>
            
            <div class="input-group">
                <input type="number" id="userCodeInput" placeholder="Ù…Ø«Ø§Ù„: 123456" maxlength="6" autofocus>
                <input type="text" id="userNameInput" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="margin-top: 10px;">
            </div>
            
            <button class="button" onclick="registerUser()">
                ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ù„Ø¨Ø¯Ø¡
            </button>
            
            <div style="margin-top: 20px; color: #6c757d; font-size: 0.9rem;">
                âš¡ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·
            </div>
        </div>
    </div>

    <!-- ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© -->
    <div id="appContainer" class="container" style="display: none;">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <div class="header">
            <h1>ğŸ“± Ù…Ø±Ø§Ø³Ù„Ø© Ù…Ø¨Ø§Ø´Ø±Ø© P2P</h1>
            <div class="user-info">
                <div class="user-code" id="myCodeDisplay">000000</div>
                <div id="userNameDisplay">Ù…Ø³ØªØ®Ø¯Ù…</div>
            </div>
            <div class="status" id="connectionStatus">
                <div class="status-dot"></div>
                <span id="statusText">ØºÙŠØ± Ù…ØªØµÙ„</span>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
            <div class="chat-area">
                <div class="messages-container" id="messagesContainer">
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ’¬</div>
                        <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                        <p>Ù‚Ù… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                    </div>
                </div>
                
                <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
                <div class="message-input">
                    <div class="input-container">
                        <textarea 
                            id="messageInput" 
                            placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."
                            rows="1"
                            disabled
                        ></textarea>
                        <button class="button" id="sendBtn" disabled onclick="sendMessage()">
                            ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 10px; color: #6c757d; font-size: 0.8rem;">
                        â†µ Ø§Ø¶ØºØ· Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                    </div>
                </div>
            </div>

            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <div class="control-panel">
                <div class="panel-section">
                    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                    
                    <div class="input-group">
                        <label>ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="myCode" readonly style="background: #f8f9fa;">
                            <button class="button secondary" onclick="copyMyCode()" style="width: auto; padding: 0 15px;">
                                ğŸ“‹ Ù†Ø³Ø®
                            </button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>ÙƒÙˆØ¯ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±:</label>
                        <input type="number" id="peerCodeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
                    </div>
                    
                    <button class="button success" id="connectBtn" onclick="connectToPeer()">
                        ğŸ”Œ Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                    
                    <button class="button danger" id="disconnectBtn" onclick="disconnect()" disabled>
                        âŒ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                </div>
                
                <div class="panel-section">
                    <h3>ğŸ“ ØªØ¹Ù„ÙŠÙ…Ø§Øª</h3>
                    <ol style="padding-right: 20px; color: #495057; line-height: 1.8;">
                        <li>Ø§Ù†Ø³Ø® ÙƒÙˆØ¯Ùƒ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</li>
                        <li>Ø£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±</li>
                        <li>Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±</li>
                        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ù„Ø§ØªØµØ§Ù„"</li>
                        <li>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©!</li>
                    </ol>
                </div>
                
                <div class="panel-section">
                    <h3>ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª</h3>
                    <button class="button secondary" onclick="clearChat()">
                        ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                    </button>
                    <button class="button secondary" onclick="changeUser()" style="margin-top: 10px;">
                        ğŸ”„ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
    <div id="notificationArea"></div>

    <script>
        // ========== Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ==========
        let myCode = '';
        let myName = 'Ù…Ø³ØªØ®Ø¯Ù…';
        let peerConnection = null;
        let dataChannel = null;
        let messages = [];
        let isConnected = false;
        let isCaller = false;

        // ========== WebRTC Configuration ==========
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' }
            ]
        };

        // ========== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        function registerUser() {
            const codeInput = document.getElementById('userCodeInput');
            const nameInput = document.getElementById('userNameInput');
            
            let code = codeInput.value.trim();
            let name = nameInput.value.trim();
            
            if (!code || code.length < 3) {
                showNotification('error', 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ù…ÙƒÙˆÙ† Ù…Ù† 3 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                codeInput.focus();
                return;
            }
            
            if (name.length > 20) {
                showNotification('error', 'Ø®Ø·Ø£', 'Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 20 Ø­Ø±ÙØ§Ù‹');
                nameInput.focus();
                return;
            }
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            myCode = code;
            myName = name || 'Ù…Ø³ØªØ®Ø¯Ù…';
            
            localStorage.setItem('p2p_code', myCode);
            localStorage.setItem('p2p_name', myName);
            
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            updateUserDisplay();
            loadMessages();
            
            showNotification('success', 'Ù…Ø±Ø­Ø¨Ø§Ù‹!', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒÙˆØ¯: ${myCode}`);
        }

        // ========== Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        function updateUserDisplay() {
            document.getElementById('myCodeDisplay').textContent = myCode;
            document.getElementById('userNameDisplay').textContent = myName;
            document.getElementById('myCode').value = myCode;
        }

        // ========== Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ==========
        async function connectToPeer() {
            const peerCodeInput = document.getElementById('peerCodeInput');
            const peerCode = peerCodeInput.value.trim();
            
            if (!peerCode || peerCode.length < 3) {
                showNotification('error', 'Ø®Ø·Ø£', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ ØµØ­ÙŠØ­');
                peerCodeInput.focus();
                return;
            }
            
            if (peerCode === myCode) {
                showNotification('error', 'Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†ÙØ³Ùƒ');
                return;
            }
            
            if (isConnected) {
                showNotification('warning', 'Ø§ØªØµØ§Ù„ Ù†Ø´Ø·', 'Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }
            
            showNotification('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', `Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙƒÙˆØ¯: ${peerCode}`);
            updateStatus('connecting');
            
            // Ø­ÙØ¸ ÙƒÙˆØ¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø£Ø®ÙŠØ±
            localStorage.setItem('last_peer_code', peerCode);
            
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
                peerConnection = new RTCPeerConnection(configuration);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ù†Ø§Ø© Ø¨ÙŠØ§Ù†Ø§Øª
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // Ø­ÙØ¸ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ localStorage (Ù†Ø¸Ø§Ù… Ø¨Ø³ÙŠØ· Ù„Ù„ØªÙˆØ§ØµÙ„)
                const connectionData = {
                    type: 'offer',
                    offer: offer,
                    fromCode: myCode,
                    fromName: myName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(`offer_${peerCode}`, JSON.stringify(connectionData));
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ø¯
                checkForAnswer(peerCode);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„');
                updateStatus('disconnected');
            }
        }

        // ========== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯ ==========
        async function checkForAnswer(peerCode) {
            let attempts = 0;
            const maxAttempts = 30; // 30 Ø«Ø§Ù†ÙŠØ©
            
            const checkInterval = setInterval(async () => {
                attempts++;
                
                if (attempts > maxAttempts) {
                    clearInterval(checkInterval);
                    showNotification('error', 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„');
                    disconnect();
                    return;
                }
                
                const answerData = localStorage.getItem(`answer_${myCode}`);
                if (answerData) {
                    clearInterval(checkInterval);
                    
                    try {
                        const data = JSON.parse(answerData);
                        if (data.type === 'answer' && data.toCode === myCode) {
                            await peerConnection.setRemoteDescription(data.answer);
                            
                            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
                            localStorage.removeItem(`answer_${myCode}`);
                            localStorage.removeItem(`offer_${peerCode}`);
                            
                            showNotification('success', 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„!', `ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ ${data.fromName || peerCode}`);
                            updateStatus('connected');
                            isConnected = true;
                            updateUI();
                        }
                    } catch (error) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø¯:', error);
                        disconnect();
                    }
                }
                
                // Ø£ÙŠØ¶Ù‹Ø§ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„)
                const incomingOffer = localStorage.getItem(`offer_${myCode}`);
                if (incomingOffer && !isCaller) {
                    clearInterval(checkInterval);
                    handleIncomingOffer(JSON.parse(incomingOffer));
                }
                
            }, 1000);
        }

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© ==========
        async function handleIncomingOffer(offerData) {
            if (isConnected) {
                showNotification('warning', 'Ø§ØªØµØ§Ù„ Ù…Ø±ÙÙˆØ¶', 'Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }
            
            showNotification('info', 'Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯', `Ø·Ù„Ø¨ Ø§ØªØµØ§Ù„ Ù…Ù† ${offerData.fromName || offerData.fromCode}`);
            
            try {
                peerConnection = new RTCPeerConnection(configuration);
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬ Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
                
                await peerConnection.setRemoteDescription(offerData.offer);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø¯
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                // Ø­ÙØ¸ Ø§Ù„Ø±Ø¯ ÙÙŠ localStorage
                const answerData = {
                    type: 'answer',
                    answer: answer,
                    toCode: offerData.fromCode,
                    fromCode: myCode,
                    fromName: myName,
                    timestamp: Date.now()
                };
                
                localStorage.setItem(`answer_${offerData.fromCode}`, JSON.stringify(answerData));
                
                // Ù…Ø³Ø­ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                localStorage.removeItem(`offer_${myCode}`);
                
                showNotification('success', 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„!', `ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† ${offerData.fromName || offerData.fromCode}`);
                updateStatus('connected');
                isConnected = true;
                updateUI();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªØ¹Ø°Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨ Ø§Ù„Ø§ØªØµØ§Ù„');
                disconnect();
            }
        }

        // ========== Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('âœ… Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙØªÙˆØ­Ø©');
                updateStatus('connected');
                isConnected = true;
                updateUI();
            };
            
            dataChannel.onclose = () => {
                console.log('ğŸ”’ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØºÙ„Ù‚Ø©');
                handleDisconnection();
            };
            
            dataChannel.onerror = (error) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ù†Ø§Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                handleDisconnection();
            };
            
            dataChannel.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    addMessage(message, 'received');
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                }
            };
        }

        // ========== Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ==========
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const messageText = input.value.trim();
            
            if (!messageText) {
                showNotification('warning', 'Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©');
                return;
            }
            
            if (!isConnected || !dataChannel || dataChannel.readyState !== 'open') {
                showNotification('error', 'ØºÙŠØ± Ù…ØªØµÙ„', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ù†Ø´Ø·');
                return;
            }
            
            const message = {
                type: 'message',
                text: messageText,
                sender: myName,
                senderCode: myCode,
                timestamp: new Date().toISOString(),
                messageId: Date.now() + Math.random()
            };
            
            try {
                dataChannel.send(JSON.stringify(message));
                addMessage(message, 'sent');
                input.value = '';
                input.focus();
                
                // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                saveMessages();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        // ========== Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶ ==========
        function addMessage(messageData, type) {
            // ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
            if (messages.some(msg => msg.messageId === messageData.messageId)) {
                return;
            }
            
            const message = {
                ...messageData,
                id: Date.now() + Math.random(),
                type: type
            };
            
            messages.push(message);
            renderMessage(message);
            updateMessageCount();
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            if (type === 'received') {
                const shortText = messageData.text.length > 30 ? 
                    messageData.text.substring(0, 30) + '...' : 
                    messageData.text;
                showNotification('info', `Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${messageData.sender}`, shortText);
            }
        }

        // ========== Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ==========
        function renderMessage(message) {
            const container = document.getElementById('messagesContainer');
            
            // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            const welcomeMsg = container.querySelector('div[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.type}`;
            
            const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            let senderInfo = message.sender;
            if (message.senderCode && message.senderCode !== myCode) {
                senderInfo += ` (#${message.senderCode})`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${message.text}
                </div>
                <div class="message-time">
                    ${senderInfo} - ${time}
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // ========== Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ==========
        function disconnect() {
            if (dataChannel) {
                dataChannel.close();
            }
            
            if (peerConnection) {
                peerConnection.close();
            }
            
            handleDisconnection();
            showNotification('info', 'ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„');
        }

        // ========== Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ==========
        function handleDisconnection() {
            peerConnection = null;
            dataChannel = null;
            isConnected = false;
            isCaller = false;
            
            updateStatus('disconnected');
            updateUI();
            
            // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
            const myCode = localStorage.getItem('p2p_code');
            if (myCode) {
                localStorage.removeItem(`answer_${myCode}`);
                localStorage.removeItem(`offer_${myCode}`);
            }
        }

        // ========== ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ==========
        function updateStatus(status) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            
            switch(status) {
                case 'connected':
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Ù…ØªØµÙ„';
                    break;
                case 'connecting':
                    statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                    break;
                case 'disconnected':
                    statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                    break;
            }
        }

        // ========== ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        function updateUI() {
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.getElementById('messageInput');
            
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            sendBtn.disabled = !isConnected;
            messageInput.disabled = !isConnected;
        }

        // ========== Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ ==========
        function copyMyCode() {
            navigator.clipboard.writeText(myCode)
                .then(() => {
                    showNotification('success', 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
                })
                .catch(err => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                });
        }

        // ========== Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ==========
        function clearChat() {
            if (messages.length === 0) return;
            
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) {
                messages = [];
                localStorage.removeItem('p2p_messages');
                
                const container = document.getElementById('messagesContainer');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ’¬</div>
                        <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                        <p>Ù‚Ù… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                    </div>
                `;
                
                showNotification('success', 'ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
            }
        }

        // ========== ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ==========
        function changeUser() {
            if (isConnected) {
                if (!confirm('Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø·. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
                    return;
                }
                disconnect();
            }
            
            localStorage.removeItem('p2p_code');
            localStorage.removeItem('p2p_name');
            
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            document.getElementById('userCodeInput').value = '';
            document.getElementById('userNameInput').value = '';
            document.getElementById('userCodeInput').focus();
        }

        // ========== Ø­ÙØ¸ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ==========
        function saveMessages() {
            try {
                localStorage.setItem('p2p_messages', JSON.stringify(messages.slice(-100)));
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
            }
        }

        function loadMessages() {
            try {
                const savedMessages = localStorage.getItem('p2p_messages');
                if (savedMessages) {
                    messages = JSON.parse(savedMessages);
                    messages.forEach(msg => renderMessage(msg));
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
            }
        }

        // ========== Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ==========
        function showNotification(type, title, message) {
            const notificationArea = document.getElementById('notificationArea');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'ğŸ’¡'
            };
            
            notification.innerHTML = `
                <div>${icons[type]}</div>
                <div style="flex: 1;">
                    <strong>${title}</strong>
                    <div style="font-size: 0.9rem; color: #666;">${message}</div>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // ========== ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ==========
        function updateMessageCount() {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø§Ø¯ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        }

        // ========== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ==========
        function init() {
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const savedCode = localStorage.getItem('p2p_code');
            const savedName = localStorage.getItem('p2p_name');
            
            if (savedCode) {
                myCode = savedCode;
                myName = savedName || 'Ù…Ø³ØªØ®Ø¯Ù…';
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appContainer').style.display = 'flex';
                
                updateUserDisplay();
                loadMessages();
                
                // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± ÙƒÙˆØ¯ Ø§ØªØµØ§Ù„
                const lastPeerCode = localStorage.getItem('last_peer_code');
                if (lastPeerCode) {
                    document.getElementById('peerCodeInput').value = lastPeerCode;
                }
            }
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¥Ù†ØªØ±
            document.getElementById('messageInput').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
            document.getElementById('connectBtn').addEventListener('click', () => {
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 1000);
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¯ÙˆØ±ÙŠØ§Ù‹
            setInterval(() => {
                if (!isConnected) {
                    const myCode = localStorage.getItem('p2p_code');
                    if (myCode) {
                        const incomingOffer = localStorage.getItem(`offer_${myCode}`);
                        if (incomingOffer) {
                            handleIncomingOffer(JSON.parse(incomingOffer));
                        }
                    }
                }
            }, 2000);
            
            console.log('ğŸš€ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¬Ø§Ù‡Ø²!');
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>