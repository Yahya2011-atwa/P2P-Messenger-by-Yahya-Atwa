<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© - P2P Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========== CSS ÙƒØ§Ù…Ù„ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --bg-color: #f5f7fb;
            --card-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 12px;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #e4edf5 100%);
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            position: relative;
            z-index: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.2rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4757;
            animation: pulse 2s infinite;
            position: relative;
        }

        .status-dot.connecting {
            background-color: #ffa502;
            animation: pulse-connecting 1s infinite;
        }

        .status-dot.connected {
            background-color: #2ed573;
            animation: pulse-connected 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-connecting {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(255, 165, 2, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(255, 165, 2, 0);
            }
        }

        @keyframes pulse-connected {
            0%, 100% { 
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4);
            }
            50% { 
                opacity: 0.8;
                box-shadow: 0 0 0 10px rgba(46, 213, 115, 0);
            }
        }

        /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        .app-main {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            flex: 1;
            margin-bottom: 30px;
        }

        @media (max-width: 1024px) {
            .app-main {
                grid-template-columns: 1fr;
            }
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-card {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .panel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .panel-card h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
        }

        .input-with-button input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-with-button input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-with-button input:read-only {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-primary, .btn-secondary, .btn-icon, .btn-send {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            min-width: 120px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.2);
        }

        .btn-secondary {
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-icon {
            padding: 12px;
            background: var(--light-color);
            color: var(--dark-color);
            border: 2px solid var(--border-color);
            width: 48px;
            height: 48px;
        }

        .btn-icon:hover {
            background: #e9ecef;
            border-color: var(--primary-color);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--success-color), #2a9d8f);
            color: white;
            padding: 12px 30px;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 201, 240, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ */
        .connection-info {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed var(--border-color);
        }

        .connection-info h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            transition: transform 0.2s ease;
        }

        .info-item:hover {
            transform: translateY(-3px);
        }

        .info-label {
            font-weight: 600;
            color: var(--gray-color);
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--dark-color);
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª */
        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .instructions ol {
            padding-right: 20px;
            margin-bottom: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
            padding-right: 10px;
            position: relative;
        }

        .instructions li::before {
            content: '';
            position: absolute;
            right: -20px;
            top: 8px;
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
        }

        .features {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feature-tag {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #00695c;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s ease;
        }

        .feature-tag:hover {
            transform: scale(1.05);
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© */
        .chat-section {
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chat-header h2 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .peer-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .message-count {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .messages-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: #fafbfd;
            min-height: 400px;
            max-height: 60vh;
            background-image: 
                radial-gradient(circle at 25px 25px, rgba(0,0,0,0.05) 2px, transparent 0),
                radial-gradient(circle at 75px 75px, rgba(0,0,0,0.05) 2px, transparent 0);
            background-size: 100px 100px;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray-color);
        }

        .welcome-message i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            opacity: 0.7;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-message h3 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--dark-color);
        }

        .welcome-message p {
            font-size: 1.1rem;
        }

        /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙØ±Ø¯ÙŠØ© */
        .message {
            margin-bottom: 20px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            margin-left: auto;
        }

        .message.received {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.sent .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.received .message-content {
            background: var(--light-color);
            color: var(--dark-color);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .message.sent .message-time {
            text-align: left;
            color: var(--primary-color);
        }

        .message.received .message-time {
            text-align: right;
            color: var(--gray-color);
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© */
        .message-input-area {
            padding: 25px;
            border-top: 2px solid var(--border-color);
            background: var(--card-color);
        }

        .input-container {
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        .input-container textarea {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 120px;
            transition: all 0.3s ease;
        }

        .input-container textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-container textarea:disabled {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }

        .input-actions {
            display: flex;
            gap: 10px;
        }

        .input-hint {
            text-align: center;
            margin-top: 10px;
            color: var(--gray-color);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        kbd {
            background: var(--light-color);
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        .app-footer {
            background: var(--card-color);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
            margin-top: auto;
            border: 1px solid var(--border-color);
        }

        .footer-content p {
            margin-bottom: 10px;
            color: var(--gray-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tech-badges {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .badge {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: var(--primary-color);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        #notificationArea {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            max-width: 350px;
            border-right: 4px solid var(--primary-color);
            transform-origin: left center;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%) scale(0.8); opacity: 0; }
            to { transform: translateX(0) scale(1); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(-100%) scale(0.8); }
        }

        .notification.success {
            border-right-color: var(--success-color);
        }

        .notification.error {
            border-right-color: var(--danger-color);
        }

        .notification.warning {
            border-right-color: var(--warning-color);
        }

        .notification.info {
            border-right-color: var(--primary-color);
        }

        .notification i {
            font-size: 1.5rem;
        }

        .notification.success i {
            color: var(--success-color);
        }

        .notification.error i {
            color: var(--danger-color);
        }

        .notification.warning i {
            color: var(--warning-color);
        }

        .notification.info i {
            color: var(--primary-color);
        }

        .notification-content {
            flex: 1;
        }

        .notification-content h4 {
            margin-bottom: 5px;
            font-size: 1rem;
        }

        .notification-content p {
            font-size: 0.9rem;
            color: var(--gray-color);
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ */
        .emoji-picker {
            position: fixed;
            bottom: 120px;
            left: 30px;
            background: var(--card-color);
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 300px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .emoji-picker.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .emoji-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .emoji-header h4 {
            color: var(--primary-color);
            font-size: 1rem;
        }

        .emoji-grid {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji-item {
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            text-align: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .emoji-item:hover {
            background: var(--light-color);
            transform: scale(1.2);
        }

        /* Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ */
        .reconnect-banner {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideDown 0.5s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .reconnect-banner button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reconnect-banner button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Ù…Ø®ØµØµ Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 15px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .app-main {
                gap: 20px;
            }
            
            .panel-card, .chat-header, .message-input-area {
                padding: 15px;
            }
            
            .input-with-button {
                flex-direction: column;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .message {
                max-width: 90%;
            }
            
            .emoji-picker {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
            }
            
            .reconnect-banner {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-comments"></i>
                    <h1>P2P Messenger</h1>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">ØºÙŠØ± Ù…ØªØµÙ„</span>
                </div>
            </div>
        </header>

        <!-- Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div id="reconnectBanner" class="reconnect-banner" style="display: none;">
            <span>Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ø³Ø§Ø¨Ù‚ØŒ Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ØŸ</span>
            <div>
                <button id="reconnectBtn" class="btn-reconnect">
                    <i class="fas fa-plug"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                </button>
                <button id="dismissReconnect" class="btn-reconnect">
                    <i class="fas fa-times"></i> ØªØ¬Ø§Ù‡Ù„
                </button>
            </div>
        </div>

        <main class="app-main">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
            <section class="control-panel">
                <div class="panel-card">
                    <h2><i class="fas fa-cogs"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h2>
                    
                    <div class="connection-controls">
                        <!-- ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø±Ù -->
                        <div class="control-group">
                            <label for="myId"><i class="fas fa-fingerprint"></i> Ù…Ø¹Ø±ÙÙƒ Ø§Ù„Ø®Ø§Øµ</label>
                            <div class="input-with-button">
                                <input type="text" id="myId" readonly>
                                <button id="copyMyId" class="btn-icon" title="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button id="generateId" class="btn-icon" title="ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯">
                                    <i class="fas fa-redo"></i>
                                </button>
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-info-circle"></i> ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
                            </small>
                        </div>

                        <!-- Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø£Ø®Ø±Ù‰ -->
                        <div class="control-group">
                            <label for="peerId"><i class="fas fa-user-plus"></i> Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±</label>
                            <div class="input-with-button">
                                <input type="text" id="peerId" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±Ù Ù‡Ù†Ø§">
                                <button id="connectBtn" class="btn-primary">
                                    <i class="fas fa-plug"></i> Ø§Ù„Ø§ØªØµØ§Ù„
                                </button>
                            </div>
                            <small style="color: var(--gray-color); display: block; margin-top: 5px;">
                                <i class="fas fa-history"></i> Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù Ù„Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹
                            </small>
                        </div>

                        <!-- Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
                        <div class="action-buttons">
                            <button id="disconnectBtn" class="btn-secondary" disabled>
                                <i class="fas fa-plug-circle-xmark"></i> Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                            </button>
                            <button id="clearChatBtn" class="btn-secondary">
                                <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                            </button>
                        </div>

                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
                        <div class="connection-info" id="connectionInfo" style="display: none;">
                            <h3><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Ø§Ù„Ø­Ø§Ù„Ø©:</span>
                                    <span class="info-value" id="connState">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ø§Ù„Ù†ÙˆØ¹:</span>
                                    <span class="info-value" id="connType">-</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Ø§Ù„Ø³Ø±Ø¹Ø©:</span>
                                    <span class="info-value" id="connSpeed">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª -->
                <div class="panel-card instructions">
                    <h3><i class="fas fa-lightbulb"></i> ÙƒÙŠÙ ØªØ¹Ù…Ù„ØŸ</h3>
                    <ol>
                        <li>Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ø­ÙÙˆØ¸ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</li>
                        <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±ÙÙƒ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±</li>
                        <li>Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø± ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ø®ØµØµ</li>
                        <li>Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ù„Ø§ØªØµØ§Ù„"</li>
                        <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«</li>
                    </ol>
                    <div class="features">
                        <span class="feature-tag"><i class="fas fa-shield-alt"></i> Ù…Ø´ÙØ±</span>
                        <span class="feature-tag"><i class="fas fa-bolt"></i> ÙÙˆØ±ÙŠ</span>
                        <span class="feature-tag"><i class="fas fa-server"></i> Ù„Ø§ Ø³ÙŠØ±ÙØ±Ø§Øª</span>
                        <span class="feature-tag"><i class="fas fa-save"></i> Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹</span>
                    </div>
                </div>
            </section>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
            <section class="chat-section">
                <div class="chat-container">
                    <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
                    <div class="chat-header">
                        <h2><i class="fas fa-comment-dots"></i> Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h2>
                        <div class="chat-info" id="chatInfo">
                            <span id="peerName" class="peer-name">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯</span>
                            <span class="message-count" id="messageCount">0 Ø±Ø³Ø§Ù„Ø©</span>
                        </div>
                    </div>

                    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
                    <div class="messages-container" id="messagesContainer">
                        <div class="welcome-message">
                            <i class="fas fa-handshake"></i>
                            <h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                            <p>Ù‚Ù… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        </div>
                    </div>

                    <!-- Ù…Ù†Ø·Ù‚Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
                    <div class="message-input-area">
                        <div class="input-container">
                            <textarea 
                                id="messageInput" 
                                placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." 
                                rows="2"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button id="sendBtn" class="btn-send" disabled>
                                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
                                </button>
                                <button id="emojiBtn" class="btn-icon" title="Ø¥ÙŠÙ…ÙˆØ¬ÙŠ">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-hint">
                            <i class="fas fa-keyboard"></i> Ø§Ø¶ØºØ· <kbd>Enter</kbd> Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ <kbd>Shift+Enter</kbd> Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
        <footer class="app-footer">
            <div class="footer-content">
                <p>
                    <i class="fas fa-code"></i> Ù…Ø¨Ù†ÙŠ Ø¨Ù€ 
                    <strong>WebRTC</strong> Ùˆ <strong>PeerJS</strong>
                </p>
                <p class="tech-badges">
                    <span class="badge">P2P</span>
                    <span class="badge">End-to-End</span>
                    <span class="badge">No Server</span>
                    <span class="badge">Persistent ID</span>
                </p>
            </div>
        </footer>

        <!-- Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
        <div id="notificationArea"></div>

        <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header">
                <h4>Ø§Ø®ØªØ± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</h4>
                <button class="btn-icon close-emoji">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="emoji-grid">
                <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ø¨Ø± JavaScript -->
            </div>
        </div>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª JavaScript Ø¹Ø¨Ø± CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- ÙƒÙˆØ¯ JavaScript Ù…Ø¯Ù…Ø¬ -->
    <script>
        // ========== JavaScript ÙƒØ§Ù…Ù„ ==========
        class P2PMessenger {
            constructor() {
                this.peer = null;
                this.connection = null;
                this.myId = this.getOrCreateId();
                this.messages = [];
                this.isConnected = false;
                this.connectionAttempts = 0;
                this.maxConnectionAttempts = 5;
                this.reconnectTimeout = null;
                
                this.initializeElements();
                this.initializeEventListeners();
                this.initializePeer();
                this.initializeEmojiPicker();
                this.restoreChat();
                this.updateUI();
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                this.attemptAutoReconnect();
            }

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø®Ø²Ù† Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
            getOrCreateId() {
                let savedId = localStorage.getItem('p2p_messenger_id');
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ø®Ø²Ù†ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯ ÙˆØ­ÙØ¸Ù‡
                if (!savedId) {
                    savedId = this.generatePeerId();
                    localStorage.setItem('p2p_messenger_id', savedId);
                }
                
                return savedId;
            }

            // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            generatePeerId() {
                const timestamp = Date.now().toString(36);
                const randomStr = Math.random().toString(36).substr(2, 5);
                return `user-${timestamp}-${randomStr}`;
            }

            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ±
            initializeElements() {
                this.elements = {
                    myId: document.getElementById('myId'),
                    peerId: document.getElementById('peerId'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    clearChatBtn: document.getElementById('clearChatBtn'),
                    copyMyId: document.getElementById('copyMyId'),
                    generateId: document.getElementById('generateId'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectionInfo: document.getElementById('connectionInfo'),
                    connState: document.getElementById('connState'),
                    connType: document.getElementById('connType'),
                    connSpeed: document.getElementById('connSpeed'),
                    chatInfo: document.getElementById('chatInfo'),
                    peerName: document.getElementById('peerName'),
                    messageCount: document.getElementById('messageCount'),
                    emojiBtn: document.getElementById('emojiBtn'),
                    emojiPicker: document.getElementById('emojiPicker'),
                    reconnectBanner: document.getElementById('reconnectBanner'),
                    reconnectBtn: document.getElementById('reconnectBtn'),
                    dismissReconnect: document.getElementById('dismissReconnect')
                };

                this.elements.myId.value = this.myId;
                
                // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ù…Ø¹Ø±Ù Ø§ØªØµØ§Ù„
                const lastPeerId = localStorage.getItem('p2p_last_peer');
                if (lastPeerId) {
                    this.elements.peerId.value = lastPeerId;
                }
            }

            // ØªÙ‡ÙŠØ¦Ø© PeerJS Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
            initializePeer() {
                const config = {
                    host: '0.peerjs.com',
                    port: 443,
                    path: '/',
                    secure: true,
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' },
                            { 
                                urls: 'turn:global.turn.twilio.com:3478?transport=udp',
                                username: 'c84c2b8a8bbdd0ee37934b3e1d1df6c7e4c11d5b09795bdc176a247a1e1d6a',
                                credential: 'Aedp5kY14yWgNp+flE6WlTpxTE0='
                            }
                        ],
                        iceCandidatePoolSize: 10,
                        iceTransportPolicy: 'all',
                        bundlePolicy: 'max-bundle',
                        rtcpMuxPolicy: 'require'
                    },
                    sdpSemantics: 'unified-plan'
                };

                this.peer = new Peer(this.myId, config);
                this.setupPeerEvents();
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« PeerJS
            setupPeerEvents() {
                this.peer.on('open', (id) => {
                    console.log('âœ… PeerJS Ù…ØªØµÙ„ØŒ Ø§Ù„Ù…Ø¹Ø±Ù:', id);
                    this.showNotification('success', 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹Ø±ÙÙƒ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø±');
                    this.updateConnectionStatus('connected');
                });

                this.peer.on('connection', (conn) => {
                    this.handleIncomingConnection(conn);
                });

                this.peer.on('error', (err) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ PeerJS:', err);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„
                    if (err.type === 'server-error' || err.type === 'network') {
                        this.showNotification('warning', 'ÙÙ‚Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...');
                        this.reconnectToServer();
                    } else {
                        this.showNotification('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', err.message);
                    }
                    
                    this.updateConnectionStatus('disconnected');
                });

                this.peer.on('disconnected', () => {
                    console.log('âš ï¸ ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø³ÙŠØ±ÙØ± PeerJS');
                    this.updateConnectionStatus('disconnected');
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ
                    setTimeout(() => {
                        if (!this.peer.disconnected) return;
                        this.reconnectToServer();
                    }, 3000);
                });

                this.peer.on('close', () => {
                    console.log('ğŸ”’ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ PeerJS');
                    this.updateConnectionStatus('disconnected');
                });
            }

            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
            reconnectToServer() {
                if (this.connectionAttempts >= this.maxConnectionAttempts) {
                    this.showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
                    return;
                }

                this.connectionAttempts++;
                console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ ${this.connectionAttempts}/${this.maxConnectionAttempts}`);
                
                this.showNotification('info', 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', `Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„... (${this.connectionAttempts})`);
                
                this.peer.reconnect();
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            handleIncomingConnection(conn) {
                if (this.connection && this.connection.open) {
                    conn.close();
                    this.showNotification('warning', 'Ø§ØªØµØ§Ù„ Ù…Ø±ÙÙˆØ¶', 'Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }

                this.connection = conn;
                this.setupConnectionEvents();
                this.savePeerId(conn.peer);
                this.showNotification('info', 'Ø§ØªØµØ§Ù„ ÙˆØ§Ø±Ø¯', `ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ù† ${conn.peer}`);
                this.updateConnectionStatus('connecting');
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
            setupConnectionEvents() {
                this.connection.on('open', () => {
                    this.isConnected = true;
                    this.connectionAttempts = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                    this.updateUI();
                    this.showNotification('success', 'ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„!', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø¢Ù†');
                    this.updatePeerInfo();
                    this.updateConnectionStatus('connected');
                    
                    // Ø¥Ø±Ø³Ø§Ù„ ping Ù„Ù‚ÙŠØ§Ø³ Ø³Ø±Ø¹Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    this.startConnectionMonitor();
                });

                this.connection.on('data', (data) => {
                    this.handleIncomingMessage(data);
                });

                this.connection.on('close', () => {
                    this.handleDisconnection();
                });

                this.connection.on('error', (err) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', err);
                    this.showNotification('error', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', err.message);
                });

                this.connection.on('iceStateChanged', (state) => {
                    console.log('ğŸ”„ Ø­Ø§Ù„Ø© ICE ØªØºÙŠØ±Øª:', state);
                    this.elements.connState.textContent = this.translateIceState(state);
                });
            }

            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            startConnectionMonitor() {
                clearInterval(this.connectionMonitor);
                
                this.connectionMonitor = setInterval(() => {
                    if (this.connection && this.connection.open) {
                        const startTime = Date.now();
                        this.connection.send({ type: 'ping', timestamp: startTime });
                    } else {
                        clearInterval(this.connectionMonitor);
                    }
                }, 5000);
            }

            // ØªÙ‡ÙŠØ¦Ø© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            initializeEventListeners() {
                // Ø²Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                this.elements.connectBtn.addEventListener('click', () => this.connectToPeer());
                
                // Ø²Ø± Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                
                // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                this.elements.clearChatBtn.addEventListener('click', () => this.clearChat());
                
                // Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù
                this.elements.copyMyId.addEventListener('click', () => this.copyMyId());
                
                // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
                this.elements.generateId.addEventListener('click', () => this.generateNewId());
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
                this.elements.emojiBtn.addEventListener('click', () => this.toggleEmojiPicker());
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                document.addEventListener('click', (e) => {
                    if (this.elements.emojiPicker && 
                        !this.elements.emojiPicker.contains(e.target) && 
                        !this.elements.emojiBtn.contains(e.target)) {
                        this.elements.emojiPicker.classList.remove('show');
                    }
                });
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                this.elements.reconnectBtn.addEventListener('click', () => {
                    this.elements.reconnectBanner.style.display = 'none';
                    this.connectToPeer();
                });
                
                // ØªØ¬Ø§Ù‡Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                this.elements.dismissReconnect.addEventListener('click', () => {
                    this.elements.reconnectBanner.style.display = 'none';
                });
            }

            // ØªÙ‡ÙŠØ¦Ø© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            initializeEmojiPicker() {
                const emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',
                              'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š',
                              'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©',
                              'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’', 'ğŸ˜', 'ğŸ˜”', 'ğŸ˜Ÿ', 'ğŸ˜•', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜£',
                              'ğŸ˜–', 'ğŸ˜«', 'ğŸ˜©', 'ğŸ¥º', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¤', 'ğŸ˜ ', 'ğŸ˜¡', 'ğŸ¤¬',
                              'ğŸ¤¯', 'ğŸ˜³', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜±', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜“', 'ğŸ¤—',
                              'ğŸ¤”', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤¥', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¬', 'ğŸ™„', 'ğŸ˜¯',
                              'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜®', 'ğŸ˜²', 'ğŸ¥±', 'ğŸ˜´', 'ğŸ¤¤', 'ğŸ˜ª', 'ğŸ˜µ', 'ğŸ¤',
                              'ğŸ¥´', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤‘', 'ğŸ¤ ', 'ğŸ˜ˆ',
                              'ğŸ‘¿', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ¤¡', 'ğŸ’©', 'ğŸ‘»', 'ğŸ’€', 'â˜ ï¸', 'ğŸ‘½', 'ğŸ‘¾',
                              'ğŸ¤–', 'ğŸƒ', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜¹', 'ğŸ˜»', 'ğŸ˜¼', 'ğŸ˜½', 'ğŸ™€', 'ğŸ˜¿',
                              'ğŸ˜¾', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤',
                              'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘',
                              'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤',
                              'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦µ', 'ğŸ¦¿', 'ğŸ¦¶', 'ğŸ‘‚',
                              'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹',
                              'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”'];

                const emojiGrid = this.elements.emojiPicker.querySelector('.emoji-grid');
                emojis.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item';
                    emojiItem.textContent = emoji;
                    emojiItem.addEventListener('click', () => this.insertEmoji(emoji));
                    emojiGrid.appendChild(emojiItem);
                });

                // Ø²Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
                this.elements.emojiPicker.querySelector('.close-emoji').addEventListener('click', () => {
                    this.elements.emojiPicker.classList.remove('show');
                });
            }

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            attemptAutoReconnect() {
                const lastPeerId = localStorage.getItem('p2p_last_peer');
                const wasConnected = localStorage.getItem('p2p_was_connected') === 'true';
                
                if (lastPeerId && wasConnected) {
                    setTimeout(() => {
                        this.elements.reconnectBanner.style.display = 'flex';
                    }, 1000);
                }
            }

            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±
            async connectToPeer() {
                const peerId = this.elements.peerId.value.trim();
                
                if (!peerId) {
                    this.showNotification('warning', 'Ù…Ø¹Ø±Ù Ù…Ø·Ù„ÙˆØ¨', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø¢Ø®Ø±');
                    return;
                }
                
                if (peerId === this.myId) {
                    this.showNotification('warning', 'Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù†ÙØ³Ùƒ');
                    return;
                }
                
                if (this.connection && this.connection.open) {
                    this.showNotification('warning', 'Ø§ØªØµØ§Ù„ Ù†Ø´Ø·', 'Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø· Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }

                this.showNotification('info', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...', `Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ${peerId}`);
                this.updateConnectionStatus('connecting');
                
                try {
                    this.connection = this.peer.connect(peerId, {
                        reliable: true,
                        serialization: 'json',
                        metadata: {
                            client: 'P2P Messenger',
                            version: '1.0',
                            timestamp: Date.now()
                        }
                    });
                    
                    this.savePeerId(peerId);
                    this.setupConnectionEvents();
                    
                    // Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                    this.reconnectTimeout = setTimeout(() => {
                        if (!this.isConnected) {
                            this.showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
                            this.disconnect();
                            this.updateConnectionStatus('disconnected');
                        }
                    }, 15000);
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    this.showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', error.message);
                    this.updateConnectionStatus('disconnected');
                }
            }

            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            savePeerId(peerId) {
                localStorage.setItem('p2p_last_peer', peerId);
                localStorage.setItem('p2p_was_connected', 'true');
            }

            // Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
            disconnect() {
                if (this.connection) {
                    this.connection.close();
                }
                this.handleDisconnection();
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
            handleDisconnection() {
                this.isConnected = false;
                this.connection = null;
                clearTimeout(this.reconnectTimeout);
                clearInterval(this.connectionMonitor);
                this.updateUI();
                this.showNotification('info', 'ØªÙ… Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„', 'ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±');
                this.updateConnectionStatus('disconnected');
                localStorage.setItem('p2p_was_connected', 'false');
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
            sendMessage() {
                const messageText = this.elements.messageInput.value.trim();
                
                if (!messageText) {
                    this.showNotification('warning', 'Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©', 'Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©');
                    return;
                }
                
                if (!this.isConnected || !this.connection || !this.connection.open) {
                    this.showNotification('error', 'ØºÙŠØ± Ù…ØªØµÙ„', 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ù†Ø´Ø·');
                    return;
                }

                const message = {
                    type: 'message',
                    text: messageText,
                    timestamp: new Date().toISOString(),
                    sender: this.myId,
                    messageId: Date.now() + '-' + Math.random().toString(36).substr(2, 9)
                };

                try {
                    this.connection.send(message);
                    this.addMessage(message, 'sent');
                    this.elements.messageInput.value = '';
                    this.elements.messageInput.style.height = 'auto';
                    
                    // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    this.saveMessages();
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                    this.showNotification('error', 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
                }
            }

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
            handleIncomingMessage(data) {
                if (data.type === 'message') {
                    this.addMessage(data, 'received');
                    this.saveMessages();
                } else if (data.type === 'ping') {
                    this.connection.send({ type: 'pong', timestamp: data.timestamp });
                } else if (data.type === 'pong') {
                    const latency = Date.now() - data.timestamp;
                    this.elements.connSpeed.textContent = `${latency}ms`;
                }
            }

            // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            addMessage(messageData, type) {
                // ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙƒØ±Ø±Ø©
                if (this.messages.some(msg => msg.messageId === messageData.messageId)) {
                    return;
                }
                
                const message = {
                    ...messageData,
                    id: Date.now() + Math.random(),
                    type: type,
                    localTimestamp: new Date().toISOString()
                };
                
                this.messages.push(message);
                this.renderMessage(message);
                this.updateMessageCount();
                this.scrollToBottom();
                
                // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                if (type === 'received') {
                    this.showNotification('info', 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©', messageData.text.substring(0, 50) + '...');
                }
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            renderMessage(message) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.type}`;
                messageElement.dataset.id = message.id;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageElement.innerHTML = `
                    <div class="message-content">
                        ${this.escapeHtml(message.text)}
                        <div class="message-time">
                            <i class="far fa-clock"></i>
                            ${time}
                        </div>
                    </div>
                `;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                const welcomeMessage = this.elements.messagesContainer.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.elements.messagesContainer.appendChild(messageElement);
            }

            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            restoreChat() {
                try {
                    const savedMessages = localStorage.getItem('p2p_messages');
                    if (savedMessages) {
                        this.messages = JSON.parse(savedMessages);
                        this.messages.forEach(msg => this.renderMessage(msg));
                        this.updateMessageCount();
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                    localStorage.removeItem('p2p_messages');
                }
            }

            // Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            saveMessages() {
                try {
                    // Ø­ÙØ¸ Ø¢Ø®Ø± 100 Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ†
                    const messagesToSave = this.messages.slice(-100);
                    localStorage.setItem('p2p_messages', JSON.stringify(messagesToSave));
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
                }
            }

            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUI() {
                const isConnected = this.isConnected && this.connection && this.connection.open;
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                this.elements.connectBtn.disabled = isConnected;
                this.elements.disconnectBtn.disabled = !isConnected;
                this.elements.messageInput.disabled = !isConnected;
                this.elements.sendBtn.disabled = !isConnected;
                
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
                this.elements.connectionInfo.style.display = isConnected ? 'block' : 'none';
                
                if (isConnected) {
                    this.updateConnectionMetrics();
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            updateConnectionStatus(status) {
                const statusDot = this.elements.connectionStatus.querySelector('.status-dot');
                const statusText = this.elements.connectionStatus.querySelector('.status-text');
                
                statusDot.className = 'status-dot';
                
                switch(status) {
                    case 'connected':
                        statusDot.classList.add('connected');
                        statusText.textContent = 'Ù…ØªØµÙ„';
                        break;
                    case 'connecting':
                        statusDot.classList.add('connecting');
                        statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                        break;
                    case 'disconnected':
                        statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                        break;
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
            updateConnectionMetrics() {
                if (this.connection && this.peer) {
                    this.elements.connType.textContent = this.connection.type || 'P2P';
                    this.elements.connState.textContent = 'Ù†Ø´Ø·';
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
            updatePeerInfo() {
                if (this.connection) {
                    this.elements.peerName.textContent = `Ù…Ø³ØªØ®Ø¯Ù…: ${this.connection.peer.substring(0, 15)}...`;
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            updateMessageCount() {
                const count = this.messages.length;
                this.elements.messageCount.textContent = `${count} Ø±Ø³Ø§Ù„Ø©`;
            }

            // Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            clearChat() {
                if (this.messages.length === 0) return;
                
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ')) {
                    this.messages = [];
                    this.elements.messagesContainer.innerHTML = `
                        <div class="welcome-message">
                            <i class="fas fa-handshake"></i>
                            <h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ ÙÙŠ Ù…Ù†ØµØ© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</h3>
                            <p>Ù‚Ù… Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø®Øµ Ø¢Ø®Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        </div>
                    `;
                    this.updateMessageCount();
                    localStorage.removeItem('p2p_messages');
                    this.showNotification('success', 'ØªÙ… Ø§Ù„Ù…Ø³Ø­', 'ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                }
            }

            // Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù
            copyMyId() {
                navigator.clipboard.writeText(this.myId)
                    .then(() => {
                        this.showNotification('success', 'ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©');
                    })
                    .catch(err => {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                        this.showNotification('error', 'Ø®Ø·Ø£', 'ØªØ¹Ø°Ø± Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù');
                    });
            }

            // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
            generateNewId() {
                if (this.isConnected) {
                    this.showNotification('warning', 'Ø§ØªØµØ§Ù„ Ù†Ø´Ø·', 'Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„');
                    return;
                }
                
                this.myId = this.generatePeerId();
                this.elements.myId.value = this.myId;
                localStorage.setItem('p2p_messenger_id', this.myId);
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Peer
                if (this.peer) {
                    this.peer.destroy();
                }
                this.initializePeer();
                
                this.showNotification('success', 'ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯', 'ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯');
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            showNotification(type, title, message) {
                const notificationArea = document.getElementById('notificationArea');
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                
                const icons = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };
                
                notification.innerHTML = `
                    <i class="${icons[type]}"></i>
                    <div class="notification-content">
                        <h4>${title}</h4>
                        <p>${message}</p>
                    </div>
                `;
                
                notificationArea.appendChild(notification);
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†Ù
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            scrollToBottom() {
                this.elements.messagesContainer.scrollTop = this.elements.messagesContainer.scrollHeight;
            }

            // ØªØ­ÙˆÙŠÙ„ Ø­Ø§Ù„Ø© ICE
            translateIceState(state) {
                const states = {
                    'new': 'Ø¬Ø¯ÙŠØ¯',
                    'checking': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚',
                    'connected': 'Ù…ØªØµÙ„',
                    'completed': 'Ù…ÙƒØªÙ…Ù„',
                    'failed': 'ÙØ´Ù„',
                    'disconnected': 'Ù…Ù†Ù‚Ø·Ø¹',
                    'closed': 'Ù…ØºÙ„Ù‚'
                };
                return states[state] || state;
            }

            // Ù…Ù†Ø¹ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© (HTML escaping)
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Ø¥Ø¯Ø±Ø§Ø¬ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            insertEmoji(emoji) {
                const input = this.elements.messageInput;
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const text = input.value;
                
                input.value = text.substring(0, start) + emoji + text.substring(end);
                input.focus();
                input.selectionStart = input.selectionEnd = start + emoji.length;
                
                this.elements.emojiPicker.classList.remove('show');
            }

            // ØªØ¨Ø¯ÙŠÙ„ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
            toggleEmojiPicker() {
                this.elements.emojiPicker.classList.toggle('show');
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', () => {
            const app = new P2PMessenger();
            window.p2pMessenger = app; // Ù„Ø¬Ø¹Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ§Ø­Ù‹Ø§ ÙÙŠ ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ…
            console.log('ğŸš€ P2P Messenger Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…!');
            
            // Ø§Ù„ØªØ­Ø°ÙŠØ± Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø©
            window.addEventListener('beforeunload', (e) => {
                if (app.isConnected) {
                    e.preventDefault();
                    e.returnValue = 'Ù„Ø¯ÙŠÙƒ Ø§ØªØµØ§Ù„ Ù†Ø´Ø·. Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©ØŸ';
                }
            });
        });
    </script>
</body>
</html>